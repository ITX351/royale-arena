# Royale Arena 后台测试模块重构任务列表

## 项目概述
根据项目要求，我们需要对后台的所有测试模块进行重构：
- 单元测试应该测试当前模块内的函数是否管用，而不是调用API是否管用
- 现有的API测试逻辑可以移入集成测试中，而非删除
- 检查每个模块已有的测试函数是否符合要求
- 如果符合则标注已完成，如果需要修改则标注任务列表待修改

## 测试模块分析与重构任务

### 1. handlers 模块测试

#### 1.1 admin.rs
- [x] 现有测试是直接调用handler函数进行测试，符合单元测试要求
- [x] 测试了登录成功、密码错误、用户不存在等场景
- [x] 符合要求，无需修改

#### 1.2 admin_game.rs
- [ ] 现有测试使用了API调用方式进行测试，不符合单元测试要求
- [ ] 需要重构为直接调用service层函数进行测试
- 任务:
  - [ ] 将现有API测试迁移至集成测试
  - [ ] 添加直接调用admin_game_service模块函数的单元测试
  - [ ] 测试create_game、update_game、delete_game等函数的逻辑

#### 1.3 admin_user.rs
- [ ] 现有测试使用了API调用方式进行测试，不符合单元测试要求
- [ ] 需要重构为直接调用service层函数进行测试
- 任务:
  - [ ] 将现有API测试迁移至集成测试
  - [ ] 添加直接调用admin_service模块函数的单元测试
  - [ ] 测试create_admin_user_handler函数的逻辑

#### 1.4 director.rs
- [ ] 现有测试使用了API调用方式进行测试，不符合单元测试要求
- [ ] 需要重构为直接调用service层函数进行测试
- 任务:
  - [ ] 将现有API测试迁移至集成测试
  - [ ] 添加直接调用相关service函数的单元测试
  - [ ] 测试add_players、get_players、delete_players等函数的逻辑

#### 1.5 export.rs
- [ ] 现有测试使用了API调用方式进行测试，不符合单元测试要求
- [ ] 需要重构为直接调用相关函数进行测试
- 任务:
  - [ ] 将现有API测试迁移至集成测试
  - [ ] 添加直接调用相关函数的单元测试
  - [ ] 测试export_game_data函数的逻辑

#### 1.6 game.rs
- [ ] 现有测试使用了API调用方式进行测试，不符合单元测试要求
- [ ] 需要重构为直接调用相关函数进行测试
- 任务:
  - [ ] 将现有API测试迁移至集成测试
  - [ ] 添加直接调用相关函数的单元测试
  - [ ] 测试get_games、get_game_info等函数的逻辑

#### 1.7 kill_records.rs
- [ ] 现有测试使用了API调用方式进行测试，不符合单元测试要求
- [ ] 需要重构为直接调用相关函数进行测试
- 任务:
  - [ ] 将现有API测试迁移至集成测试
  - [ ] 添加直接调用相关函数的单元测试
  - [ ] 测试get_game_kills函数的逻辑

#### 1.8 logs.rs
- [ ] 现有测试使用了API调用方式进行测试，不符合单元测试要求
- [ ] 需要重构为直接调用相关函数进行测试
- 任务:
  - [ ] 将现有API测试迁移至集成测试
  - [ ] 添加直接调用相关函数的单元测试
  - [ ] 测试get_game_logs函数的逻辑

#### 1.9 places.rs
- [ ] 现有测试使用了API调用方式进行测试，不符合单元测试要求
- [ ] 需要重构为直接调用相关函数进行测试
- 任务:
  - [ ] 将现有API测试迁移至集成测试
  - [ ] 添加直接调用相关函数的单元测试
  - [ ] 测试get_places_status、update_place_status等函数的逻辑

#### 1.10 player.rs
- [ ] 现有测试使用了API调用方式进行测试，不符合单元测试要求
- [ ] 需要重构为直接调用相关函数进行测试
- 任务:
  - [ ] 将现有API测试迁移至集成测试
  - [ ] 添加直接调用相关函数的单元测试
  - [ ] 测试get_player_info、player_login等函数的逻辑

#### 1.11 reset.rs
- [ ] 现有测试使用了API调用方式进行测试，不符合单元测试要求
- [ ] 需要重构为直接调用相关函数进行测试
- 任务:
  - [ ] 将现有API测试迁移至集成测试
  - [ ] 添加直接调用相关函数的单元测试
  - [ ] 测试reset_game函数的逻辑

#### 1.12 rule_templates.rs
- [ ] 现有测试使用了API调用方式进行测试，不符合单元测试要求
- [ ] 需要重构为直接调用相关函数进行测试
- 任务:
  - [ ] 将现有API测试迁移至集成测试
  - [ ] 添加直接调用相关函数的单元测试
  - [ ] 测试get_rule_templates、get_rule_template等函数的逻辑

#### 1.13 rules.rs
- [ ] 现有测试使用了API调用方式进行测试，不符合单元测试要求
- [ ] 需要重构为直接调用相关函数进行测试
- 任务:
  - [ ] 将现有API测试迁移至集成测试
  - [ ] 添加直接调用相关函数的单元测试
  - [ ] 测试get_game_rules函数的逻辑

#### 1.14 snapshot.rs
- [ ] 现有测试使用了API调用方式进行测试，不符合单元测试要求
- [ ] 需要重构为直接调用相关函数进行测试
- 任务:
  - [ ] 将现有API测试迁移至集成测试
  - [ ] 添加直接调用相关函数的单元测试
  - [ ] 测试get_game_snapshot函数的逻辑

#### 1.15 stats.rs
- [ ] 现有测试使用了API调用方式进行测试，不符合单元测试要求
- [ ] 需要重构为直接调用相关函数进行测试
- 任务:
  - [ ] 将现有API测试迁移至集成测试
  - [ ] 添加直接调用相关函数的单元测试
  - [ ] 测试get_game_stats函数的逻辑

#### 1.16 votes.rs
- [ ] 现有测试使用了API调用方式进行测试，不符合单元测试要求
- [ ] 需要重构为直接调用相关函数进行测试
- 任务:
  - [ ] 将现有API测试迁移至集成测试
  - [ ] 添加直接调用相关函数的单元测试
  - [ ] 测试get_game_votes函数的逻辑

#### 1.17 websocket.rs
- [ ] 现有测试主要是结构体和impl块的测试，符合单元测试要求
- [ ] 部分测试可以进一步完善
- 任务:
  - [ ] 增加更多针对handle_player_action、handle_director_command等函数的测试

#### 1.18 ws_auth.rs
- [ ] 现有测试是直接调用handler函数进行测试，符合单元测试要求
- [ ] 测试了各种认证场景
- [x] 符合要求，无需修改

#### 1.19 ws_connect.rs
- [ ] 该文件没有测试代码，需要补充
- 任务:
  - [ ] 添加单元测试

### 2. services 模块测试

#### 2.1 actor_service.rs
- [x] 现有测试是直接调用service函数进行测试，符合单元测试要求
- [x] 测试了演员数据的创建和密码验证
- [x] 符合要求，无需修改

#### 2.2 admin_game_service.rs
- [x] 现有测试是直接调用service函数进行测试，符合单元测试要求
- [x] 测试了游戏和规则模板的创建、更新、删除等操作
- [x] 测试了各种验证函数
- [x] 符合要求，无需修改

#### 2.3 admin_service.rs
- [x] 现有测试是直接调用service函数进行测试，符合单元测试要求
- [x] 测试了管理员用户的创建和密码验证
- [x] 符合要求，无需修改

#### 2.4 db_helper.rs
- [ ] 该文件没有测试代码，需要补充
- 任务:
  - [ ] 添加单元测试

#### 2.5 db.rs
- [ ] 该文件没有测试代码，需要补充
- 任务:
  - [ ] 添加单元测试

#### 2.6 game_service.rs
- [x] 现有测试是直接测试结构体序列化，符合单元测试要求
- [ ] 可以增加更多针对service函数的测试
- 任务:
  - [ ] 添加针对get_game_from_db、get_rule_template_from_db等函数的测试

#### 2.7 kill_record_service.rs
- [ ] 该文件没有测试代码，需要补充
- 任务:
  - [ ] 添加单元测试

### 3. models 模块测试

#### 3.1 actor.rs
- [x] 现有测试是直接测试结构体的创建和验证，符合单元测试要求
- [x] 测试了验证函数的各种边界情况
- [x] 符合要求，无需修改

#### 3.2 admin.rs
- [x] 现有测试是直接测试结构体的创建和序列化，符合单元测试要求
- [x] 符合要求，无需修改

#### 3.3 admin_game.rs
- [ ] 该文件没有测试代码，但主要是数据结构定义，可以不添加测试
- [x] 符合要求

#### 3.4 game.rs
- [x] 现有测试是直接测试结构体的创建和验证，符合单元测试要求
- [x] 测试了验证函数的各种边界情况
- [x] 测试了状态管理函数
- [x] 符合要求，无需修改

#### 3.5 kill_record.rs
- [x] 现有测试是直接测试结构体的创建和验证，符合单元测试要求
- [x] 测试了验证函数的各种边界情况
- [x] 符合要求，无需修改

#### 3.6 place.rs
- [x] 现有测试是直接测试结构体的创建和验证，符合单元测试要求
- [x] 测试了验证函数的各种边界情况
- [x] 测试了玩家管理函数
- [x] 测试了状态管理函数
- [x] 符合要求，无需修改

#### 3.7 player.rs
- [x] 现有测试是直接测试结构体的创建和验证，符合单元测试要求
- [x] 测试了验证函数的各种边界情况
- [x] 测试了密码哈希和验证功能
- [x] 测试了状态管理函数
- [x] 测试了装备管理函数
- [x] 测试了行动能力检查函数
- [x] 符合要求，无需修改

#### 3.8 rule_template.rs
- [x] 现有测试是直接测试结构体的创建和验证，符合单元测试要求
- [x] 测试了验证函数的各种边界情况
- [x] 测试了不同模板类型的创建
- [x] 符合要求，无需修改

#### 3.9 rules.rs
- [x] 现有测试是直接测试结构体的创建和验证，符合单元测试要求
- [x] 测试了验证函数的各种边界情况
- [x] 测试了队友行为标志的处理
- [x] 测试了自定义规则创建
- [x] 符合要求，无需修改

### 4. test_common 模块测试

#### 4.1 test_data.rs
- [x] 现有测试验证了测试数据管理器的功能，符合单元测试要求
- [x] 符合要求，无需修改

#### 4.2 test_init.rs
- [x] 现有测试验证了测试环境初始化功能，符合单元测试要求
- [x] 符合要求，无需修改

#### 4.3 test_utils.rs
- [x] 现有测试验证了测试工具函数的功能，符合单元测试要求
- [x] 符合要求，无需修改

### 5. 其他测试文件

#### 5.1 services/db_test.rs
- [x] 现有测试验证了数据库连接功能，符合单元测试要求
- [x] 符合要求，无需修改

#### 5.2 integration_tests.rs
- [ ] 该文件是集成测试占位符，需要完善
- 任务:
  - [ ] 将从handlers模块迁移的API测试添加到此文件
  - [ ] 添加更多的集成测试场景

## 重构优先级建议

### 高优先级（需要立即处理）
1. handlers模块中所有使用API调用方式进行测试的文件
2. 缺少测试代码的文件（db_helper.rs、db.rs、kill_record_service.rs等）

### 中优先级（需要优化）
1. websocket.rs - 增加更多函数测试
2. game_service.rs - 增加service函数测试

### 低优先级（已经符合要求）
1. 所有models模块的测试
2. services模块中已有测试的文件
3. test_common模块的测试
4. services/db_test.rs

## 完成情况统计
- 已完成（无需修改）: 15个模块
- 待修改: 18个模块
- 待补充: 6个模块
- 待完善: 1个模块