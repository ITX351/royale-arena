# Royale Arena 后端上下文

## 技术栈

- 编程语言：Rust
- Web框架：Actix-web
- WebSocket库：用于实现实时通信
- 数据库访问：直接使用MySQL驱动，不使用ORM
- 序列化：serde库用于JSON序列化
- 日志：使用tracing或log库进行日志记录

## 核心功能模块

### 1. REST API服务器
处理HTTP请求，提供以下功能：
- 用户认证（仅用于管理员登录验证）
- 游戏状态及设置查询
- 玩家信息获取
- 游戏规则获取

### 2. WebSocket服务器
处理实时通信，提供以下功能：
- 玩家行动指令接收
- 实时游戏状态推送
- 导演操作指令处理
- 行动结果反馈

### 3. 游戏逻辑引擎
核心业务逻辑处理：
- 行动时间窗口管理
- 玩家状态更新（生命值、体力值、位置等）
- 道具系统处理（搜索、使用、合成等）
- 安全区缩圈逻辑
- 投票系统处理

### 4. 数据管理模块
- 静态数据访问：通过MySQL数据库存储玩家信息等
- 动态数据管理：游戏运行时所有数据仅在内存中处理
- 数据持久化：行动结束后将游戏状态保存到本地文件

## 数据存储策略

### MySQL数据库
存储静态数据：
- 玩家账户信息（用户名、明文密码）
- 游戏基本信息（ID、名称、管理密码、游戏规则设置等）
- 系统配置信息

### 内存存储
游戏运行时所有动态数据存储在内存中：
- 玩家实时状态
- 游戏进度信息
- 道具和位置信息

### 本地文件
行动结束后将游戏状态序列化保存到本地文件，用于后续查询和分析。

## 接口设计

### REST API端点
- `POST /api/login` - 用户登录验证
- `GET /api/game/{id}` - 获取游戏基本信息
- `GET /api/player/{id}` - 获取玩家详细信息
- `GET /api/rules` - 获取游戏规则

### WebSocket通信
- 建立连接时进行身份验证
- 玩家发送行动指令：移动、搜索、攻击、使用道具
- 服务器推送实时状态更新
- 导演发送控制指令：开始行动、结束行动、缩圈、空投等

## 系统约束

1. 不使用任何游戏引擎或第三方实时通信服务
2. 不使用ORM框架，直接操作MySQL数据库
3. WebSocket仅处理实时操作指令
4. REST API仅处理认证和状态查询
5. 游戏过程中不访问数据库，所有数据都在内存中
6. 不复用旧版Python系统的任何代码

## 性能要求

1. 高并发处理能力，支持最多100名玩家同时在线
2. 低延迟响应，确保实时操作的流畅性
3. 内存高效管理，避免内存泄漏
4. 稳定性高，能够长时间运行

## 安全考虑

1. 除管理员密码外，所有密码明文存储（仅为项目特定设计，实际生产环境中存在安全风险）
2. 通过URI中的密码参数直接访问导演控制台和玩家界面
3. WebSocket连接的身份验证机制
4. 防止恶意操作的验证机制

## 与前端的关系

- 提供REST API供前端查询游戏状态和规则
- 通过WebSocket与前端进行实时通信
- 处理前端发送的所有玩家行动指令
- 向导演控制台推送实时游戏状态更新

## 开发原则

1. 模块化设计：按功能拆分代码到不同模块，使用与目录同名的.rs文件替代mod.rs文件。
2. 单元测试：面向测试开发，开发新功能的同时编写单元测试模块；按照Rust的单元测试惯例，将测试代码的模块跟待测试的正常代码放入同一个文件中。
3. 集成测试：开发完新功能后，编写集成测试模块，与src同级的tests目录下存储集成测试代码。
4. 测试编写要求：
   - 避免代码重复：测试代码应遵循DRY原则，对于公用的功能（如创建测试应用实例）应定义公用函数供各个测试模块调用
   - 模块化测试：对于有代码复用需求的测试模块，应定义相关的辅助函数避免大量代码的复制粘贴
   - 测试工具：VSCode中使用的测试工具是`CodeLLDB`