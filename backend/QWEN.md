# Royale Arena 后端上下文

## 技术栈

- 编程语言：Rust
- Web框架：Actix-web
- WebSocket库：用于实现实时通信
- 数据库访问：直接使用MySQL驱动，不使用ORM
- 序列化：serde库用于JSON序列化
- 日志：使用tracing或log库进行日志记录

## 核心功能模块

### 1. REST API服务器
处理HTTP请求，提供以下功能：
- 用户认证（仅用于管理员登录验证）
- 游戏状态及设置查询
- 玩家信息获取
- 游戏规则获取

### 2. WebSocket服务器
处理实时通信，提供以下功能：
- 玩家行动指令接收
- 实时游戏状态推送
- 导演操作指令处理
- 行动结果反馈

### 3. 游戏逻辑引擎
核心业务逻辑处理：
- 行动时间窗口管理
- 玩家状态更新（生命值、体力值、位置等）
- 道具系统处理（搜索、使用、合成等）
- 安全区缩圈逻辑
- 投票系统处理

### 4. 数据管理模块
- 静态数据访问：通过MySQL数据库存储玩家信息等
- 动态数据管理：游戏运行时所有数据仅在内存中处理
- 数据持久化：行动结束后将游戏状态保存到本地文件
- 规则配置管理：采用JSON格式存储游戏规则，提供灵活的规则扩展机制

## 数据存储策略

### MySQL数据库
存储静态数据：
- 玩家账户信息（用户名、明文密码）
- 游戏基本信息（ID、名称、管理密码、游戏规则设置等）
- 系统配置信息
- 管理员帐户信息

### 游戏规则存储
游戏规则采用JSON格式存储，以提供最大的灵活性和可扩展性：
- 规则模板存储在`rule_templates`表中，使用`rules_config` JSON字段存储完整规则配置
- 通过JSON格式，可以轻松添加新规则字段而无需修改数据库表结构
- 支持默认值机制，确保旧数据与新规则兼容
- 详细设计请参考[规则存储设计文档](../docs/backend/rule-storage-design.md)

### 内存存储
游戏运行时所有动态数据存储在内存中：
- 玩家实时状态
- 游戏进度信息
- 道具和位置信息

### 本地文件
行动结束后将游戏状态序列化保存到本地文件，用于后续查询和分析。

## 系统约束

1. 不使用任何游戏引擎或第三方实时通信服务
2. 不使用ORM框架，直接操作MySQL数据库
3. WebSocket仅处理实时操作指令
4. REST API仅处理认证和状态查询
5. 游戏过程中不访问数据库，所有数据都在内存中

## 安全考虑

1. 除管理员密码外，所有密码明文存储（仅为项目特定设计，实际生产环境中存在安全风险）
2. 通过URI中的密码参数直接访问导演控制台和玩家界面
3. WebSocket连接的身份验证机制
4. 防止恶意操作的验证机制

## 开发约束

1. 模块化设计：按功能拆分代码到不同模块，**按照最新的rust规范，新建新目录时，永远不使用任何`mod.rs`文件**，改为使用与目录同名的`.rs`文件替代之。
永远不使用任何mod.rs，改为使用与目录同名的文件。
永远不使用任何mod.rs，改为使用与目录同名的文件。
永远不使用任何mod.rs，改为使用与目录同名的文件。
永远不使用任何mod.rs，改为使用与目录同名的文件。
永远不使用任何mod.rs，改为使用与目录同名的文件。
永远不使用任何mod.rs，改为使用与目录同名的文件。
永远不使用任何mod.rs，改为使用与目录同名的文件。
永远不使用任何mod.rs，改为使用与目录同名的文件。
永远不使用任何mod.rs，改为使用与目录同名的文件。
2. 单元测试：面向测试开发，开发新功能的同时编写单元测试模块；按照Rust的单元测试惯例，将测试代码的模块跟待测试的正常代码放入同一个文件中。
3. 集成测试：开发完新功能后，编写集成测试模块，与src同级的tests目录下存储集成测试代码。
4. 测试编写要求：
   - 避免代码重复：测试代码应遵循DRY原则，对于公用的功能（如创建测试应用实例）应定义公用函数供各个测试模块调用
   - 模块化测试：对于有代码复用需求的测试模块，应定义相关的辅助函数避免大量代码的复制粘贴
   - 测试工具：VSCode中使用的测试工具是`CodeLLDB`
   - 测试数据管理：所有测试都应该与真实数据库交互，需要测试数据时应该在测试开始时自动向数据库插入相关数据，在测试结束时删除刚刚添加的数据
   - 测试数据组织：为了避免在每个测试入口处分别临时提供测试数据，应该建立专门的测试数据管理机制，可以新建文件用来管理临时的测试数据。通过TestDataManager创建实际的数据库记录，避免返回模拟数据而不测试真实功能
   - 不能因为"测试环境特殊"就跳过密码验证等安全检查，不能只测试成功情况，忽略失败场景。
   - 测试数据必须正确清理，不能影响其他测试。
   - 公用测试接口：为了提高测试代码的复用性，项目提供了公用的测试接口，位于`src/test_common`目录下，包括：
     - `test_init.rs`：测试环境初始化模块，负责加载测试环境变量
     - `test_utils.rs`：测试工具模块，提供创建测试应用实例和测试状态的函数
     - `test_data.rs`：测试数据管理模块，负责在数据库中创建和清理测试数据
   - 正确调用公用测试接口：
     - 在测试开始时调用`init_test_env()`函数初始化测试环境
     - 使用`create_test_app_state()`创建测试应用状态
     - 使用`TestDataManager`管理测试数据的创建和清理
     - 在集成测试中使用`create_test_app()`创建测试应用实例
   - 自动化测试：每次修改代码后，应该自动运行`cargo test`命令来确保没有破坏现有功能。可以通过在终端中执行`cd backend/royale-arena-backend && cargo test`来运行所有测试。
   - **测试中应使用共享的数据库连接池而不是创建新的连接池，以避免并行测试时的端口冲突和资源竞争。使用`get_shared_db_pool()`函数获取全局共享的数据库连接。**