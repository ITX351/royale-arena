# 路由配置

<cite>
**本文档引用的文件**   
- [router/index.ts](file://frontend\src\router\index.ts)
- [main.ts](file://frontend\src\main.ts)
- [App.vue](file://frontend\src\App.vue)
- [HomePage.vue](file://frontend\src\views\HomePage.vue)
- [AdminLoginPage.vue](file://frontend\src\views\admin\AdminLoginPage.vue)
- [AdminLayout.vue](file://frontend\src\views\admin\AdminLayout.vue)
- [admin.ts](file://frontend\src\stores\admin.ts)
- [ActorMain.vue](file://frontend\src\views\actor\ActorMain.vue)
- [DirectorMain.vue](file://frontend\src\views\director\DirectorMain.vue)
</cite>

## 更新摘要
**变更内容**   
- 新增了演员操作台路由配置，包括 `/game/:id/actor` 和带密码的 `/game/:id/actor/:password`
- 更新了导演控制台路由，增加了带密码的 `/game/:id/director/:password` 路径
- 修正了首页标题为"雾雨小镇大逃杀"
- 更新了路由守卫逻辑，在需要认证时才初始化管理员状态
- 新增了演员界面和导演界面的组件分析
- 更新了导航方式示例，包含演员和导演的访问流程

## 目录
1. [项目结构分析](#项目结构分析)
2. [路由配置详解](#路由配置详解)
3. [路由实例的创建与挂载](#路由实例的创建与挂载)
4. [路由目标组件分析](#路由目标组件分析)
5. [导航方式](#导航方式)
6. [路由守卫与扩展](#路由守卫与扩展)

## 项目结构分析

royale-arena 前端项目采用典型的 Vue 3 单页应用（SPA）结构，基于 Vite 构建工具。项目源码位于 `frontend/src` 目录下，主要包含以下几个核心模块：

- **`router/`**: 路由配置模块，定义了应用的页面导航逻辑。
- **`views/`**: 视图组件模块，存放顶级路由对应的页面组件。
- **`components/`**: 可复用的 UI 组件模块。
- **`stores/`**: 状态管理模块，使用 Pinia。
- **`App.vue`**: 应用的根组件。
- **`main.ts`**: 应用的入口文件。

项目新增了演员操作台相关组件，位于 `views/actor/` 目录下，包括主界面、状态组件和功能面板。同时完善了导演控制台的功能。

```
graph TB
subgraph "前端项目结构"
main[main.ts<br/>入口文件]
App[App.vue<br/>根组件]
router[router/index.ts<br/>路由配置]
views[views/<br/>视图组件]
components[components/<br/>通用组件]
stores[stores/<br/>状态管理]
end
main --> App
main --> router
App --> router
App --> views
App --> components
router --> views
```

**Section sources**
- [main.ts](file://frontend\src\main.ts#L1-L23)
- [App.vue](file://frontend\src\App.vue#L1-L17)
- [router/index.ts](file://frontend\src\router\index.ts#L1-L175)

## 路由配置详解

路由配置的核心文件是 `router/index.ts`。该文件使用 Vue Router 4 提供的 API 来定义应用的路由规则。

### 路由记录（Routes）定义

在 `router/index.ts` 中，通过 `routes` 数组定义了多个路由记录，分为公共路由、管理员登录路由和管理员后台路由：

```typescript
const routes = [
  // 公共路由
  {
    path: '/',
    name: 'Home',
    component: HomePage,
    meta: {
      title: '雾雨小镇大逃杀 - 首页'
    }
  },
  {
    path: '/game/:id',
    name: 'GameDetail',
    component: GameDetailPage,
    meta: {
      title: '游戏详情'
    }
  },
  {
    path: '/game/:id/player',
    name: 'PlayerInterface',
    component: PlayerInterface,
    meta: {
      title: '玩家界面'
    }
  },
  {
    path: '/game/:id/director',
    name: 'DirectorMain',
    component: DirectorMain,
    meta: {
      title: '导演控制台'
    }
  },
  {
    path: '/game/:id/director/:password',
    name: 'DirectorMainWithPassword',
    component: DirectorMain,
    meta: {
      title: '导演控制台'
    }
  },
  {
    path: '/game/:id/actor',
    name: 'ActorMain',
    component: ActorMain,
    meta: {
      title: '演员界面'
    }
  },
  {
    path: '/game/:id/actor/:password',
    name: 'ActorMainWithPassword',
    component: ActorMain,
    meta: {
      title: '演员界面'
    }
  },
  
  // 管理员登录路由
  {
    path: '/admin/login',
    name: 'AdminLogin',
    component: AdminLoginPage,
    meta: {
      title: '管理员登录'
    }
  },
  
  // 管理员后台路由（需要认证）
  {
    path: '/admin',
    component: AdminLayout,
    meta: {
      requiresAuth: true,
      title: '管理后台'
    },
    redirect: '/admin/games',
    children: [
      {
        path: 'games',
        name: 'AdminGames',
        component: AdminGamesPage,
        meta: {
          title: '游戏管理'
        }
      },
      {
        path: 'rules',
        name: 'AdminRules',
        component: AdminRulesPage,
        meta: {
          title: '规则模版管理'
        }
      },
      {
        path: 'admins',
        name: 'AdminUsers',
        component: AdminUsersPage,
        meta: {
          requiresSuperAdmin: true,
          title: '管理员管理'
        }
      }
    ]
  },
  
  // 404 重定向
  {
    path: '/:pathMatch(.*)*',
    redirect: '/'
  }
]
```

- **`path`**: 定义 URL 路径。`/` 对应首页，`/admin` 对应管理员后台，`/game/:id/actor` 对应演员操作台。
- **`name`**: 为路由赋予一个唯一的名称，便于在编程式导航中引用。
- **`component`**: 指定该路径对应的 Vue 组件。
- **`meta`**: 包含路由的元信息，如页面标题和权限要求。
- **`children`**: 定义嵌套路由，用于构建复杂的页面结构。

### 路径映射

路径映射如下：
- 当用户访问 `http://localhost:5173/` 时，Vue Router 会渲染 `HomePage` 组件。
- 当用户访问 `http://localhost:5173/admin/login` 时，Vue Router 会渲染 `AdminLoginPage` 组件。
- 当用户访问 `http://localhost:5173/game/123/actor` 时，Vue Router 会渲染 `ActorMain` 组件。
- 当用户访问 `http://localhost:5173/admin/games` 时，Vue Router 会渲染 `AdminLayout` 组件内的 `AdminGamesPage` 组件。

### 组件懒加载实现

所有组件均采用动态 `import()` 语句进行懒加载：

```typescript
const HomePage = () => import('@/views/HomePage.vue')
const ActorMain = () => import('@/views/actor/ActorMain.vue')
const DirectorMain = () => import('@/views/director/DirectorMain.vue')
const AdminLoginPage = () => import('@/views/admin/AdminLoginPage.vue')
const AdminLayout = () => import('@/views/admin/AdminLayout.vue')
```

这是一种路由级别的代码分割（route-level code-splitting）策略，它确保：
1.  **延迟加载**：只有当用户首次访问对应路径时，才会向服务器请求组件代码。
2.  **代码分割**：构建工具（Vite）会将每个组件打包成独立的 JavaScript 文件（chunk）。
3.  **提升性能**：显著减少了应用的初始加载时间。

**Section sources**
- [router/index.ts](file://frontend\src\router\index.ts#L1-L175)

## 路由实例的创建与挂载

### createRouter 和 createWebHistory 的使用

`createRouter` 是 Vue Router 提供的工厂函数，用于创建一个路由实例。

```typescript
import { createRouter, createWebHistory } from 'vue-router'

const router = createRouter({
  history: createWebHistory(),
  routes: [...]
})
```

- **`createWebHistory`**: 创建一个基于 HTML5 History API 的路由历史模式。`createWebHistory()` 无参数调用，表示使用根路径作为基础路径。

### 路由实例的导出与挂载

1.  **导出**：在 `router/index.ts` 文件末尾，使用 `export default router` 将创建好的路由实例导出。
2.  **挂载**：在 `main.ts` 入口文件中，完成了路由的挂载：
    ```typescript
    import { createApp } from 'vue'
    import App from './App.vue'
    import router from './router' // 导入路由实例

    const app = createApp(App)
    app.use(router) // 使用路由插件
    app.mount('#app') // 挂载到 DOM
    ```
    `app.use(router)` 这行代码至关重要，它将 Vue Router 插件注册到 Vue 应用实例中，从而激活了路由功能。

**Section sources**
- [router/index.ts](file://frontend\src\router\index.ts#L1-L175)
- [main.ts](file://frontend\src\main.ts#L1-L23)

## 路由目标组件分析

### HomePage.vue 加载机制

`HomePage.vue` 是应用的首页组件，其加载机制是**动态的**。

```vue
<template>
  <div class="home-page">
    <!-- 顶部导航 -->
    <header class="header">
      <div class="container">
        <div class="header-content">
          <div class="logo-section">
            <h1 class="logo">雾雨小镇大逃杀</h1>
          </div>
          ...
        </div>
      </div>
    </header>
    ...
  </div>
</template>
```

- **动态导入**：在 `router/index.ts` 中通过 `const HomePage = () => import('@/views/HomePage.vue')` 动态导入。
- **功能**：作为公共路由的入口，包含游戏列表、搜索和筛选功能。

### 演员和导演相关组件加载机制

#### ActorMain.vue

`ActorMain.vue` 是演员操作台的主界面组件，其加载机制是**动态的**。

```vue
<template>
  <div class="shared-main">
    <!-- 加载状态 -->
    <div v-if="loading" class="shared-loading-container">
      <el-skeleton animated>
        <template #template>
          <el-skeleton-item variant="h3" style="width: 30%" />
          <div style="margin-top: 20px">
            <el-skeleton-item variant="p" style="width: 50%" />
          </div>
        </template>
      </el-skeleton>
    </div>

    <!-- 错误状态 -->
    <el-alert
      v-else-if="error"
      :title="error"
      type="error"
      show-icon
      :closable="false"
      class="shared-alert"
    />

    <!-- 主内容 -->
    <div v-else-if="game" class="shared-content">
      <!-- 左右分栏布局 -->
      <div class="shared-main-layout">
        <!-- 左侧内容区域 -->
        <div class="shared-left-content">
          <!-- 题头组件 -->
          <Header 
            :game="game" 
            :actor-password="actorPassword"
          />

          <!-- WebSocket连接状态提示 -->
          <el-alert
            v-if="webSocketConnecting"
            title="正在连接到游戏服务器..."
            type="info"
            show-icon
            :closable="false"
            class="shared-alert"
          />

          <el-alert
            v-else-if="!webSocketConnected && game.status === GameStatus.RUNNING"
            title="WebSocket连接已断开，正在尝试重连..."
            type="warning"
            show-icon
            :closable="false"
            class="shared-alert"
          />

          <!-- 状态页面内容 -->
          <component 
            :is="currentStateComponent" 
            :game="gameWithData"
            :actor-password="actorPassword"
          />
        </div>

        <!-- 右侧日志消息区域 -->
        <div class="shared-right-content">
          <LogMessage 
            v-if="shouldShowLogMessage"
            :messages="logMessages"
            :players="playerList"
            class="shared-log-message"
          />
        </div>
      </div>
    </div>
  </div>
</template>
```

- **动态加载**：在 `router/index.ts` 中通过 `const ActorMain = () => import('@/views/actor/ActorMain.vue')` 动态导入。
- **功能**：提供演员操作台的完整界面，包含题头、状态显示、实时日志等。支持通过URL参数传递密码。

#### DirectorMain.vue

`DirectorMain.vue` 是导演控制台的主界面组件，其加载机制是**动态的**。

```vue
<template>
  <div class="shared-main">
    <!-- 加载状态 -->
    <div v-if="loading" class="shared-loading-container">
      <el-skeleton animated>
        <template #template>
          <el-skeleton-item variant="h3" style="width: 30%" />
          <div style="margin-top: 20px">
            <el-skeleton-item variant="p" style="width: 50%" />
          </div>
        </template>
      </el-skeleton>
    </div>

    <!-- 错误状态 -->
    <el-alert
      v-else-if="error"
      :title="error"
      type="error"
      show-icon
      :closable="false"
      class="shared-alert"
    />

    <!-- 主内容 -->
    <div v-else-if="game" class="shared-content">
      <!-- 左右分栏布局 -->
      <div class="shared-main-layout">
        <!-- 左侧内容区域 -->
        <div class="shared-left-content">
          <!-- 题头组件 -->
          <Header 
            :game="game" 
            :director-password="directorPassword"
            @status-updated="handleStatusUpdated"
          />

          <!-- WebSocket连接状态提示 -->
          <el-alert
            v-if="webSocketConnecting"
            title="正在连接到游戏服务器..."
            type="info"
            show-icon
            :closable="false"
            class="shared-alert"
          />

          <el-alert
            v-else-if="!webSocketConnected && game.status === GameStatus.RUNNING"
            title="WebSocket连接已断开，正在尝试重连..."
            type="warning"
            show-icon
            :closable="false"
            class="shared-alert"
          />

          <!-- 管理页面内容 -->
          <component 
            :is="currentManagementComponent" 
            :game="gameWithData"
            :director-password="directorPassword"
            @refresh="refreshGame"
          />
        </div>

        <!-- 右侧日志消息区域 -->
        <div class="shared-right-content">
          <LogMessage 
            v-if="shouldShowLogMessage"
            :messages="logMessages"
            :players="playerList"
            class="shared-log-message"
          />
        </div>
      </div>
    </div>
  </div>
</template>
```

- **动态加载**：在 `router/index.ts` 中通过 `const DirectorMain = () => import('@/views/director/DirectorMain.vue')` 动态导入。
- **功能**：提供导演控制台的完整界面，包含题头、管理功能、实时日志等。支持通过URL参数传递密码。

**Section sources**
- [HomePage.vue](file://frontend\src\views\HomePage.vue#L1-L280)
- [ActorMain.vue](file://frontend\src\views\actor\ActorMain.vue#L1-L238)
- [DirectorMain.vue](file://frontend\src\views\director\DirectorMain.vue#L1-L247)

## 导航方式

### 声明式导航

声明式导航使用 `<RouterLink>` 组件，它会渲染为一个可点击的 `<a>` 标签，但点击时会阻止浏览器的默认跳转行为，并通过 Vue Router 进行内部导航。

```vue
<!-- 在 HomePage.vue 中 -->
<el-button @click="goToAdminLogin" :icon="User">管理员登录</el-button>

<script setup lang="ts">
const goToAdminLogin = () => {
  router.push('/admin/login')
}
</script>
```

- **`to` 属性**：指定要导航到的路径或命名路由。
- **优势**：语义清晰，易于理解和使用，是构建导航菜单的首选方式。

### 编程式导航

编程式导航允许在 JavaScript 代码中通过调用方法来触发导航。最常用的方法是 `router.push()`。

```typescript
// 在 AdminLoginPage.vue 中
const handleLogin = async () => {
  if (!loginFormRef.value) return

  const isValid = await loginFormRef.value.validate().catch(() => false)
  if (!isValid) return

  const result = await adminStore.login(loginForm)
  
  if (result.success) {
    ElMessage.success('登录成功')
    router.push('/admin/games')
  }
}

// 在游戏详情页中导航到演员界面
const goToActorInterface = (gameId: string, password: string) => {
  router.push(`/game/${gameId}/actor/${encodeURIComponent(password)}`)
}

// 在游戏详情页中导航到导演界面
const goToDirectorInterface = (gameId: string, password: string) => {
  router.push(`/game/${gameId}/director/${encodeURIComponent(password)}`)
}
```

- **`router.push()`**: 向浏览器历史记录栈添加一条新记录，用户点击后退按钮可以返回。
- **应用场景**：表单提交后跳转、权限验证失败后重定向、根据条件自动跳转等。

**Section sources**
- [App.vue](file://frontend\src\App.vue#L1-L17)
- [router/index.ts](file://frontend\src\router\index.ts#L1-L175)
- [HomePage.vue](file://frontend\src\views\HomePage.vue#L1-L280)
- [AdminLoginPage.vue](file://frontend\src\views\admin\AdminLoginPage.vue#L1-L229)

## 路由守卫与扩展

### 路由守卫的实现

路由守卫（Navigation Guards）是 Vue Router 提供的钩子函数，用于在导航过程中执行逻辑，例如权限验证、页面离开确认等。

#### 全局前置守卫 (Global Before Guards)

在 `router/index.ts` 中实现了全局前置守卫：

```typescript
// 路由守卫
router.beforeEach(async (to, _from, next) => {
  const adminStore = useAdminStore()
  
  // 只在需要认证的路由上才初始化认证状态，避免干扰正常的路由跳转
  if (to.meta.requiresAuth && !adminStore.isLoggedIn) {
    try {
      await adminStore.initAuth()
    } catch (err) {
      console.warn('初始化认证状态失败:', err)
    }
  }
  
  // 设置页面标题
  if (to.meta.title) {
    document.title = to.meta.title as string
  }
  
  // 检查是否需要管理员认证
  if (to.meta.requiresAuth) {
    if (!adminStore.isLoggedIn) {
      next('/admin/login')
      return
    }
    
    // 检查是否需要超级管理员权限
    if (to.meta.requiresSuperAdmin && !adminStore.isSuperAdmin) {
      next('/admin/games')
      return
    }
  }
  
  // 如果已登录管理员访问登录页，重定向到后台
  if (to.name === 'AdminLogin' && adminStore.isLoggedIn) {
    next('/admin/games')
    return
  }
  
  next()
})
```

此守卫在任何导航触发时都会被调用，主要功能包括：
1.  **页面标题设置**：根据路由的 `meta.title` 设置文档标题。
2.  **权限验证**：检查 `meta.requiresAuth` 和 `meta.requiresSuperAdmin` 来控制访问权限。
3.  **登录状态保护**：防止已登录用户访问登录页面。
4.  **按需初始化**：只在需要认证的路由上才初始化管理员状态，提高性能。

#### 状态管理集成

路由守卫依赖于 `useAdminStore` 来获取管理员的登录状态和权限信息：

```typescript
// 在 stores/admin.ts 中
export const useAdminStore = defineStore('admin', () => {
  // 状态
  const isLoggedIn = ref(false)
  const userInfo = ref<AdminUser | null>(null)
  const token = ref<string | null>(null)
  
  // 计算属性
  const isSuperAdmin = computed(() => {
    return userInfo.value?.is_super_admin || false
  })

  // 初始化检查登录状态
  const initAuth = async () => {
    const savedToken = localStorage.getItem('admin_token')
    const savedUser = localStorage.getItem('admin_user')
    
    if (savedToken && savedUser) {
      try {
        token.value = savedToken
        userInfo.value = JSON.parse(savedUser)
        isLoggedIn.value = true
      } catch (err) {
        console.warn('清除无效的管理员登录信息:', err)
        logout()
      }
    }
  }

  // 登录操作
  const login = async (credentials: LoginCredentials) => {
    // ... 调用API进行登录
  }

  // 登出操作
  const logout = () => {
    token.value = null
    userInfo.value = null
    isLoggedIn.value = false
    localStorage.removeItem('admin_token')
    localStorage.removeItem('admin_user')
  }

  return {
    isLoggedIn,
    userInfo,
    token,
    isSuperAdmin,
    initAuth,
    login,
    logout
  }
})
```

### 嵌套路由扩展方案

当前路由已经实现了嵌套路由结构，用于构建管理员后台：

```typescript
{
  path: '/admin',
  component: AdminLayout,
  meta: {
    requiresAuth: true,
    title: '管理后台'
  },
  redirect: '/admin/games',
  children: [
    {
      path: 'games',
      name: 'AdminGames',
      component: AdminGamesPage,
      meta: {
        title: '游戏管理'
      }
    },
    {
      path: 'rules',
      name: 'AdminRules',
      component: AdminRulesPage,
      meta: {
        title: '规则模版管理'
      }
    },
    {
      path: 'admins',
      name: 'AdminUsers',
      component: AdminUsersPage,
      meta: {
        requiresSuperAdmin: true,
        title: '管理员管理'
      }
    }
  ]
}
```

在 `AdminLayout.vue` 中，使用 `<router-view />` 来渲染子路由组件：

```vue
<template>
  <div class="admin-layout">
    <!-- 侧边栏 -->
    <aside class="sidebar">
      <!-- 导航菜单 -->
      <el-menu :default-active="$route.path" router>
        <el-menu-item index="/admin/games">游戏管理</el-menu-item>
        <el-menu-item index="/admin/rules">规则模版</el-menu-item>
        <el-menu-item index="/admin/admins" v-if="adminStore.isSuperAdmin">管理员管理</el-menu-item>
      </el-menu>
    </aside>

    <!-- 主要内容区域 -->
    <main class="main-content">
      <div class="page-content">
        <router-view />
      </div>
    </main>
  </div>
</template>
```

这种结构非常适合构建具有侧边栏导航的复杂管理后台界面。

**Section sources**
- [router/index.ts](file://frontend\src\router\index.ts#L104-L175)
- [admin.ts](file://frontend\src\stores\admin.ts#L5-L159)
- [AdminLayout.vue](file://frontend\src\views\admin\AdminLayout.vue#L136-L200)