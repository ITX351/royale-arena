# 数据访问层

<cite>
**本文档引用的文件**  
- [main.rs](file://backend/royale-arena-backend/src/main.rs)
- [Cargo.toml](file://backend/royale-arena-backend/Cargo.toml)
- [20250825105153_init_schema.up.sql](file://backend/royale-arena-backend/migrations/20250825105153_init_schema.up.sql)
- [20250825105158_seed_test_data.up.sql](file://backend/royale-arena-backend/migrations/20250825105158_seed_test_data.up.sql)
- [README.md](file://backend/royale-arena-backend/migrations/README.md)
- [QWEN.md](file://backend/QWEN.md)
- [database.rs](file://backend/royale-arena-backend/src/database.rs)
- [service.rs](file://backend/royale-arena-backend/src/admin/service.rs)
- [models.rs](file://backend/royale-arena-backend/src/admin/models.rs)
- [models.rs](file://backend/royale-arena-backend/src/game/models.rs) - *更新了游戏状态枚举*
- [20250826121055_add_game_status_hidden_deleted.up.sql](file://backend/royale-arena-backend/migrations/20250826121055_add_game_status_hidden_deleted.up.sql) - *新增迁移脚本*
- [service.rs](file://backend/royale-arena-backend/src/game/service.rs) - *更新了游戏服务逻辑*
- [errors.rs](file://backend/royale-arena-backend/src/game/errors.rs) - *新增错误类型*
- [handlers.rs](file://backend/royale-arena-backend/src/game/handlers.rs) - *更新了API处理器*
- [service.rs](file://backend/royale-arena-backend/src/director/service.rs) - *新增导演对演员的批量操作接口*
- [models.rs](file://backend/royale-arena-backend/src/director/models.rs) - *新增批量操作数据模型*
- [handlers.rs](file://backend/royale-arena-backend/src/director/handlers.rs) - *新增导演API处理器*
</cite>

## 更新摘要
**已做更改**  
- 新增“导演对演员的批量操作”部分，详细说明`DirectorService`中实现的批量添加、查询和删除演员的接口。
- 更新“主要实体与CRUD操作”部分，在`actors`实体描述中补充与导演功能相关的操作说明。
- 更新所有受影响部分的来源引用，新增对`director/service.rs`、`director/models.rs`和`director/handlers.rs`的引用。
- 保持原有文档结构和未受影响部分不变。

## 目录
1. [项目结构](#项目结构)
2. [数据库连接与SQLx配置](#数据库连接与sqlx配置)
3. [数据库迁移流程](#数据库迁移流程)
4. [主要实体与CRUD操作](#主要实体与crud操作)
5. [游戏状态筛选机制](#游戏状态筛选机制)
6. [事务管理机制](#事务管理机制)
7. [测试数据种子加载](#测试数据种子加载)
8. [导演对演员的批量操作](#导演对演员的批量操作)

## 项目结构

项目采用分层架构，后端使用Rust语言开发，前端使用TypeScript，另有Python脚本用于导演控制。数据访问层位于`backend/royale-arena-backend`目录下，核心数据库操作通过SQLx库与MySQL交互。

```
mermaid
graph TB
subgraph "后端"
A[royale-arena-backend]
B[migrations]
C[sql]
D[src]
end
subgraph "前端"
E[royale-arena-frontend]
end
subgraph "脚本"
F[python_directors]
end
B --> A
C --> A
D --> A
E --> A
F --> A
```

**图示来源**  
- [migrations](file://backend/royale-arena-backend/migrations/README.md)
- [src](file://backend/royale-arena-backend/src/main.rs)

**本节来源**  
- [README.md](file://README.md)
- [QWEN.md](file://backend/QWEN.md)

## 数据库连接与SQLx配置

数据访问层使用SQLx作为异步数据库驱动，通过`sqlx` crate与MySQL数据库进行安全、类型安全的交互。在`Cargo.toml`中已声明相关依赖和特性。

```toml
[dependencies]
sqlx = { version = "0.8.6", features = ["runtime-tokio-rustls", "mysql", "chrono", "uuid"] }
```

关键特性说明：
- **mysql**: 启用MySQL数据库支持
- **runtime-tokio-rustls**: 使用Tokio异步运行时和Rustls TLS库
- **chrono**: 支持时间类型（如TIMESTAMP）的序列化
- **uuid**: 支持UUID类型作为主键

数据库连接通过环境变量`DATABASE_URL`配置，格式为`mysql://user:password@host:port/database`。项目使用`dotenvy`加载`.env`文件中的配置。

数据库连接池在`database.rs`中创建，通过`create_pool`函数返回一个`MySqlPool`实例。

```rust
// backend/src/database.rs
pub async fn create_pool(config: &AppConfig) -> Result<DatabasePool, sqlx::Error> {
    MySqlPool::connect(&config.database_url).await
}
```

**本节来源**  
- [Cargo.toml](file://backend/royale-arena-backend/Cargo.toml#L10-L14)
- [QWEN.md](file://backend/QWEN.md#L7-L12)
- [database.rs](file://backend/royale-arena-backend/src/database.rs#L0-L7)

## 数据库迁移流程

数据库迁移使用`sqlx-cli`工具管理，确保数据库结构的版本控制和一致性。迁移脚本位于`backend/royale-arena-backend/migrations/`目录。

### 迁移工作流
1. **创建迁移**：使用`sqlx migrate add -r <name>`命令生成新的迁移文件对（`.up.sql`和`.down.sql`）
2. **应用迁移**：执行`sqlx migrate run`按时间戳顺序应用所有未执行的`.up.sql`脚本
3. **回滚迁移**：执行`sqlx migrate revert`运行最近一次迁移的`.down.sql`脚本

### 迁移脚本结构
每个迁移包含两个SQL文件：
- **{timestamp}_init_schema.up.sql**: 创建数据库表结构
- **{timestamp}_seed_test_data.up.sql**: 插入初始测试数据
- **{timestamp}_add_game_status_hidden_deleted.up.sql**: 为游戏状态添加'hidden'和'deleted'状态

最近的迁移`20250826121055_add_game_status_hidden_deleted.up.sql`修改了`games`表的`status`字段，添加了`hidden`和`deleted`两个新的枚举值。

```sql
-- 修改games表的status字段，添加新的枚举值
ALTER TABLE games MODIFY COLUMN status ENUM('waiting', 'running', 'paused', 'ended', 'hidden', 'deleted') NOT NULL DEFAULT 'waiting' COMMENT '游戏状态';
```

```
mermaid
flowchart TD
A[开发者] --> B[创建新迁移]
B --> C[编写.up.sql和.down.sql]
C --> D[提交到版本控制]
D --> E[部署时运行sqlx migrate run]
E --> F[自动应用新迁移]
```

**图示来源**  
- [20250825105153_init_schema.up.sql](file://backend/royale-arena-backend/migrations/20250825105153_init_schema.up.sql)
- [README.md](file://backend/royale-arena-backend/migrations/README.md)
- [20250826121055_add_game_status_hidden_deleted.up.sql](file://backend/royale-arena-backend/migrations/20250826121055_add_game_status_hidden_deleted.up.sql)

**本节来源**  
- [README.md](file://backend/royale-arena-backend/migrations/README.md#L0-L83)
- [20250825105153_init_schema.up.sql](file://backend/royale-arena-backend/migrations/20250825105153_init_schema.up.sql)
- [20250826121055_add_game_status_hidden_deleted.up.sql](file://backend/royale-arena-backend/migrations/20250826121055_add_game_status_hidden_deleted.up.sql)

## 主要实体与CRUD操作

根据`20250825105153_init_schema.up.sql`文件，系统定义了以下核心实体：

### 实体关系图
```
mermaid
erDiagram
admin_users {
VARCHAR(36) id PK
VARCHAR(50) username UK
VARCHAR(255) password
BOOLEAN is_super_admin
TIMESTAMP created_at
TIMESTAMP updated_at
}
rule_templates {
VARCHAR(36) id PK
VARCHAR(100) template_name
TEXT description
BOOLEAN is_active
JSON rules_config
TIMESTAMP created_at
TIMESTAMP updated_at
}
games {
VARCHAR(36) id PK
VARCHAR(100) name
TEXT description
VARCHAR(50) director_password
INT max_players
ENUM status
VARCHAR(36) rule_template_id FK
TIMESTAMP created_at
TIMESTAMP updated_at
}
actors {
VARCHAR(36) id PK
VARCHAR(36) game_id FK
VARCHAR(50) name
VARCHAR(8) password
INT team_id
TIMESTAMP created_at
TIMESTAMP updated_at
}
game_logs {
VARCHAR(36) id PK
VARCHAR(36) game_id FK
ENUM level
TEXT message
VARCHAR(36) player_id FK
TIMESTAMP timestamp
}
kill_records {
VARCHAR(36) id PK
VARCHAR(36) game_id FK
VARCHAR(36) killer_id FK
VARCHAR(36) victim_id FK
TIMESTAMP kill_time
VARCHAR(50) cause
VARCHAR(50) weapon
VARCHAR(100) location
}
admin_users ||--o{ games : "创建"
rule_templates ||--o{ games : "关联"
games ||--o{ actors : "包含"
games ||--o{ game_logs : "记录"
games ||--o{ kill_records : "记录"
actors ||--o{ kill_records : "击杀者"
actors ||--o{ kill_records : "被击杀者"
actors ||--o{ game_logs : "相关玩家"
```

### CRUD操作接口
根据`admin/service.rs`中的`AdminService`实现，`admin_users`表的CRUD操作如下：

#### 管理员账户 (admin_users)
- **创建**: `INSERT INTO admin_users (id, username, password, is_super_admin) VALUES (?, ?, ?, ?)`
  - **业务逻辑**: 检查用户名是否已存在，生成UUID，使用bcrypt加密密码。
- **查询 (列表)**: `SELECT id, username, password, is_super_admin, created_at, updated_at FROM admin_users ORDER BY created_at DESC`
- **查询 (单个)**: `SELECT id, username, password, is_super_admin, created_at, updated_at FROM admin_users WHERE id = ?`
- **更新**: `UPDATE admin_users SET username = ?, password = ?, is_super_admin = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?`
  - **业务逻辑**: 检查用户是否存在，更新用户名时检查冲突，可选择性更新密码（自动加密）。
- **删除**: `DELETE FROM admin_users WHERE id = ?`
  - **业务逻辑**: 检查用户是否存在，防止删除最后一个超级管理员。

**图示来源**  
- [20250825105153_init_schema.up.sql](file://backend/royale-arena-backend/migrations/20250825105153_init_schema.up.sql#L15-L114)

**本节来源**  
- [20250825105153_init_schema.up.sql](file://backend/royale-arena-backend/migrations/20250825105153_init_schema.up.sql#L15-L114)
- [service.rs](file://backend/royale-arena-backend/src/admin/service.rs#L0-L171)
- [models.rs](file://backend/royale-arena-backend/src/admin/models.rs#L0-L63)

## 游戏状态筛选机制

为了支持对游戏列表的灵活筛选，系统在`game/models.rs`中定义了`GameFilterType`枚举和`get_status_list`方法。

### 游戏状态枚举 (GameStatus)
游戏状态在数据库中为ENUM类型，在Rust代码中映射为`GameStatus`枚举，包含以下状态：
- `Waiting` (等待中)
- `Running` (进行中)
- `Paused` (已暂停)
- `Ended` (已结束)
- `Hidden` (已隐藏)
- `Deleted` (已删除)

### 筛选类型枚举 (GameFilterType)
`GameFilterType`定义了前端可用的筛选选项：
- **All**: 全部（不包括已隐藏和已删除）
- **Active**: 活动中（等待中、进行中、已暂停）
- **Waiting**: 等待中
- **Running**: 进行中
- **Ended**: 已结束
- **Hidden**: 已隐藏
- **Deleted**: 已删除（管理员可见）

### 筛选逻辑实现
`get_status_list`方法将筛选类型转换为对应的游戏状态列表，用于构建SQL查询的`IN`子句。

```rust
// backend/src/game/models.rs
impl GameFilterType {
    pub fn get_status_list(&self) -> Vec<GameStatus> {
        match self {
            GameFilterType::All => vec![
                GameStatus::Waiting,
                GameStatus::Running,
                GameStatus::Paused,
                GameStatus::Ended,
            ],
            // ... 其他匹配分支
        }
    }
}
```

在`GameService`的`get_games`方法中，根据`GameFilterType`构建动态查询，确保了数据访问层与业务逻辑的紧密集成。

**本节来源**  
- [models.rs](file://backend/royale-arena-backend/src/game/models.rs#L100-L150)
- [service.rs](file://backend/royale-arena-backend/src/game/service.rs#L100-L150)

## 事务管理机制

项目通过`sqlx::test`宏在测试中实现了自动事务管理。根据`QWEN.md`文档，数据库集成测试使用`#[sqlx::test(migrations = "./migrations")]`属性，该机制会：

1. 自动创建一个临时测试数据库
2. 应用所有迁移脚本
3. 在测试函数中注入一个`MySqlPool`连接池
4. **测试结束后自动回滚所有更改并销毁数据库**

这种设计确保了每个测试都在干净、隔离的环境中运行，避免了测试间的数据污染。

```rust
#[sqlx::test(migrations = "../migrations")]
async fn test_game_creation(pool: MySqlPool) {
    // 在此函数中执行的数据库操作
    // 测试结束后会自动回滚
}
```

对于生产环境，虽然当前代码中未使用显式事务（如`pool.begin().await?`），但SQLx完全支持。例如，在需要保证多个操作原子性时，可以使用：

```rust
let mut tx = pool.begin().await?;
// 执行多个数据库操作
tx.commit().await?; // 或 tx.rollback().await?
```

**本节来源**  
- [QWEN.md](file://backend/QWEN.md#L50-L58)
- [README.md](file://backend/royale-arena-backend/migrations/README.md#L30-L38)

## 测试数据种子加载

测试数据通过专门的迁移脚本`20250825105158_seed_test_data.up.sql`加载，确保开发和测试环境有一致的初始数据。

### 加载内容
- **管理员账户**: 2个测试管理员（a, b）
- **规则模板**: 2个预设模板（经典模式、快速模式）
- **游戏实例**: 2个测试游戏
- **演员账户**: 4个测试演员

### 加载机制
使用`INSERT IGNORE`语句，允许脚本重复执行而不会因唯一约束冲突失败。

```sql
-- 插入测试管理员账户
INSERT IGNORE INTO admin_users (id, username, password, is_super_admin)
VALUES
  ('3e6aa7c8-197a-4627-8ead-0afb2f050677', 'a', '$2b$12$j/bJMGgwyj0tzDSRHZWQZuMPqwOdgCRDMQLO6Sle/ONIMcDMXE15e', TRUE),
  ('00f2bd7d-99f8-4bc7-a4a8-f2293549f726', 'b', '$2b$12$xQn6ti4eKhH4H3MXn2OdHufT1HWv.NZOI2rVizjjPYfLkDFKt7zFC', FALSE);
```

此脚本作为迁移流程的一部分，在`sqlx migrate run`时自动执行。

**本节来源**  
- [20250825105158_seed_test_data.up.sql](file://backend/royale-arena-backend/migrations/20250825105158_seed_test_data.up.sql)
- [README.md](file://backend/royale-arena-backend/migrations/README.md#L0-L38)

## 导演对演员的批量操作

根据`director/service.rs`和`director/models.rs`中的实现，系统新增了导演对演员的批量管理接口，支持批量添加、查询和删除演员。

### 批量操作数据模型
- **BatchAddPlayersRequest**: 批量添加演员请求，包含演员列表
- **CreatePlayerRequest**: 单个演员创建请求，包含名称、密码和可选队伍ID
- **BatchDeletePlayersRequest**: 批量删除演员请求，包含演员ID列表
- **BatchOperationResponse<T>**: 通用批量操作响应，包含成功和失败列表
- **OperationFailure**: 操作失败信息，包含失败原因和关联ID或名称

### 批量操作接口
#### 批量添加演员
- **API**: `POST /director/{game_id}/players?password={director_password}`
- **业务逻辑**:
  1. 验证导演密码
  2. 对每个演员进行数据验证（名称非空、密码格式等）
  3. 检查名称是否重复
  4. 逐个创建演员，记录成功与失败
- **返回**: `BatchOperationResponse<PlayerInfo>`，包含成功创建的演员信息和失败原因

#### 获取演员列表
- **API**: `GET /director/{game_id}/players?password={director_password}`
- **业务逻辑**:
  1. 验证导演密码
  2. 查询指定游戏的所有演员
- **返回**: `PlayersListResponse`，包含所有演员信息

#### 批量删除演员
- **API**: `DELETE /director/{game_id}/players?password={director_password}`
- **业务逻辑**:
  1. 验证导演密码
  2. 检查游戏状态是否为"waiting"（仅允许在等待中状态删除）
  3. 验证演员存在性及归属
  4. 逐个删除演员，记录成功与失败
- **返回**: `BatchOperationResponse<DeleteSuccessInfo>`，包含成功删除的演员信息和失败原因

**本节来源**  
- [service.rs](file://backend/royale-arena-backend/src/director/service.rs#L0-L293)
- [models.rs](file://backend/royale-arena-backend/src/director/models.rs#L0-L180)
- [handlers.rs](file://backend/royale-arena-backend/src/director/handlers.rs#L0-L83)