# 数据库设计

<cite>
**本文档引用的文件**  
- [20250825105153_init_schema.up.sql](file://backend\migrations\20250825105153_init_schema.up.sql) - *数据库表结构定义*
- [20250826121055_add_game_status_hidden_deleted.up.sql](file://backend\migrations\20250826121055_add_game_status_hidden_deleted.up.sql) - *扩展游戏状态枚举*
- [20250826121055_add_game_status_hidden_deleted.down.sql](file://backend\migrations\20250826121055_add_game_status_hidden_deleted.down.sql) - *回滚游戏状态变更*
- [20250915152136_game_rule_json.up.sql](file://backend\migrations\20250915152136_game_rule_json.up.sql) - *将规则配置从模版迁移至游戏表*
- [20250915152136_game_rule_json.down.sql](file://backend\migrations\20250915152136_game_rule_json.down.sql) - *回滚规则配置迁移*
- [README.md](file://backend\migrations\README.md) - *数据库迁移指南*
- [Cargo.toml](file://backend\Cargo.toml) - *项目依赖配置*
- [database.rs](file://backend\src\database.rs) - *数据库连接池管理*
- [models.rs](file://backend\src\admin\models.rs) - *管理员数据模型定义*
- [service.rs](file://backend\src\admin\service.rs) - *管理员服务与数据库交互*
- [main.rs](file://backend\src\main.rs) - *应用启动与数据库初始化*
- [game/models.rs](file://backend\src\game\models.rs) - *游戏数据模型定义*
- [game/service.rs](file://backend\src\game\service.rs) - *游戏服务与业务逻辑*
- [game/handlers.rs](file://backend\src\game\handlers.rs) - *游戏API处理器*
- [game/errors.rs](file://backend\src\game\errors.rs) - *游戏错误定义*
- [rule_template/models.rs](file://backend\src\rule_template\models.rs) - *规则模版数据模型定义*
- [rule_template/service.rs](file://backend\src\rule_template\service.rs) - *规则模版服务逻辑*
- [frontend/src/types/game.ts](file://frontend\src\types\game.ts) - *前端游戏类型定义*
- [frontend/src/utils/gameFilter.ts](file://frontend\src\utils\gameFilter.ts) - *前端游戏过滤工具*
</cite>

## 更新摘要
**已更新内容**  
- **游戏实例表 (games)**：更新了 `status` 字段的说明，增加了 `hidden` 和 `deleted` 两种新状态。
- **数据库ER图**：更新了ER图，以反映 `games` 表中新增的状态。
- **SQLx类型安全查询模式**：扩展了该部分，以涵盖新的 `GameStatus` 和 `GameFilterType` 枚举在Rust和前端代码中的实现。
- **新增章节**：添加了“游戏状态与筛选逻辑”章节，详细说明了新增状态的业务含义和前后端的筛选逻辑。
- **核心表字段详解**：彻底重构了“游戏实例表 (games)”和“游戏规则模版表 (rule_templates)”的说明，以反映最新的数据库结构变更。
- **数据库ER图**：更新了ER图，移除了 `games` 表与 `rule_templates` 表之间的外键关系，并将 `rules_config` 字段添加到 `games` 表中。
- **数据库迁移策略与版本控制**：新增了对 `20250915152136_game_rule_json` 迁移文件的说明。
- **SQLx类型安全查询模式**：更新了代码示例和说明，以反映 `Game` 模型中 `rules_config` 字段的变更。

**新增文件引用**  
- 添加了 `20250915152136_game_rule_json.up.sql` 和 `.down.sql` 文件的引用。
- 添加了后端 `game/models.rs`, `service.rs`, `rule_template/models.rs`, `rule_template/service.rs` 文件的引用。

## 目录
1. [数据库实体关系与表结构](#数据库实体关系与表结构)  
2. [核心表字段详解](#核心表字段详解)  
   2.1. [管理员账户表 (admin_users)](#管理员账户表-admin_users)  
   2.2. [游戏规则模版表 (rule_templates)](#游戏规则模版表-rule_templates)  
   2.3. [游戏实例表 (games)](#游戏实例表-games)  
   2.4. [演员账户表 (actors)](#演员账户表-actors)  
3. [数据库ER图](#数据库er图)  
4. [数据库迁移策略与版本控制](#数据库迁移策略与版本控制)  
5. [SQLx类型安全查询模式](#sqlx类型安全查询模式)
6. [游戏状态与筛选逻辑](#游戏状态与筛选逻辑)

## 数据库实体关系与表结构

本项目采用关系型数据库MySQL，数据库名为 `royale_arena`，字符集为 `utf8mb4`，排序规则为 `utf8mb4_unicode_ci`。数据库设计围绕游戏管理与运行的核心业务，包含管理员、游戏实例、规则模版、演员（玩家）及日志记录等实体。

主要表及其关系如下：
- `admin_users`：存储系统管理员信息，是系统管理入口。
- `rule_templates`：存储可复用的游戏规则配置模版，支持JSON格式的灵活规则定义。
- `games`：存储具体的游戏实例。**已更新**：此表不再通过外键关联 `rule_templates` 表，而是直接在 `rules_config` 字段中存储游戏规则的完整JSON配置。这实现了规则的“快照”功能，确保游戏一旦创建，其规则即固定不变，不受模版后续修改的影响。
- `actors`：存储参与游戏的演员（玩家）信息，通过外键 `game_id` 关联 `games` 表，形成一对多关系。
- `game_logs` 和 `kill_records`：分别记录游戏过程中的日志和击杀事件，均通过外键关联 `games` 表和 `actors` 表。

这些表通过外键约束确保了数据的完整性和一致性。

**Section sources**
- [20250825105153_init_schema.up.sql](file://backend\migrations\20250825105153_init_schema.up.sql)
- [20250826121055_add_game_status_hidden_deleted.up.sql](file://backend\migrations\20250826121055_add_game_status_hidden_deleted.up.sql)
- [20250915152136_game_rule_json.up.sql](file://backend\migrations\20250915152136_game_rule_json.up.sql)

## 核心表字段详解

### 管理员账户表 (admin_users)

该表存储系统管理员的账户信息。

**字段说明：**
- `id`：**管理员唯一标识符(UUID)**，数据类型为 `VARCHAR(36)`，主键，用于唯一标识一个管理员。
- `username`：**管理员用户名**，数据类型为 `VARCHAR(50)`，非空且唯一，作为登录凭证。
- `password`：**管理员密码(密文存储)**，数据类型为 `VARCHAR(255)`，非空，存储经过bcrypt等算法加密后的密码哈希值。
- `is_super_admin`：**是否为超级管理员**，数据类型为 `BOOLEAN`，非空，默认值为 `FALSE`，用于区分普通管理员和拥有最高权限的超级管理员。
- `created_at`：**创建时间**，数据类型为 `TIMESTAMP`，默认值为当前时间戳。
- `updated_at`：**更新时间**，数据类型为 `TIMESTAMP`，默认值为当前时间戳，并在记录更新时自动刷新。
- **索引**：在 `username` 字段上建立了唯一索引 `idx_admin_users_username`，以加速基于用户名的查询。

**Section sources**
- [20250825105153_init_schema.up.sql](file://backend\migrations\20250825105153_init_schema.up.sql#L3-L13)

### 游戏规则模版表 (rule_templates)

该表存储可重用的游戏规则配置模版，便于快速创建具有相同规则的游戏。

**字段说明：**
- `id`：**模版唯一标识符(UUID)**，数据类型为 `VARCHAR(36)`，主键。
- `template_name`：**模版名称**，数据类型为 `VARCHAR(100)`，非空，用于标识模版。
- `description`：**模版描述**，数据类型为 `TEXT`，可为空，提供模版的详细说明。
- `is_active`：**模版是否激活**，数据类型为 `BOOLEAN`，非空，默认值为 `TRUE`，用于控制模版是否可用于创建新游戏。
- `rules_config`：**完整的游戏规则配置(JSON格式)**，数据类型为 `JSON`，非空，以JSON格式存储所有游戏规则，如游戏流程、地图、玩家属性等，具有极高的灵活性。
- `created_at` 和 `updated_at`：创建和更新时间戳。
- **索引**：在 `template_name` 和 `is_active` 字段上建立了索引，以优化按名称和激活状态的查询。

**Section sources**
- [20250825105153_init_schema.up.sql](file://backend\migrations\20250825105153_init_schema.up.sql#L15-L25)

### 游戏实例表 (games)

该表存储每个具体游戏实例的基本信息。

**字段说明：**
- `id`：**游戏唯一标识符(UUID)**，主键。
- `name`：**游戏名称**，非空。
- `description`：**游戏描述**，可为空。
- `director_password`：**导演密码**，非空，用于游戏导演（管理员）控制游戏进程。
- `max_players`：**最大玩家数量**，整数类型，非空，默认值为100。
- `status`：**游戏状态**，枚举类型 `ENUM('waiting', 'running', 'paused', 'ended', 'hidden', 'deleted')`，非空，默认值为 `'waiting'`，表示游戏的生命周期状态。**已更新**：此字段已扩展，新增了 `hidden` 和 `deleted` 两种状态，用于更精细地管理游戏的可见性和生命周期。
- `rules_config`：**游戏规则配置(JSON格式)**，数据类型为 `JSON`，非空。**已更新**：此字段直接存储了游戏创建时从规则模版复制过来的完整规则配置。这使得每个游戏实例都拥有自己独立的规则“快照”，即使原始模版被修改，已创建的游戏规则也不会改变。
- `created_at` 和 `updated_at`：创建和更新时间戳。
- **索引**：在 `status` 字段上建立了索引 `idx_games_status`，便于快速查询处于特定状态的游戏。

**Section sources**
- [20250825105153_init_schema.up.sql](file://backend\migrations\20250825105153_init_schema.up.sql#L27-L41)
- [20250826121055_add_game_status_hidden_deleted.up.sql](file://backend\migrations\20250826121055_add_game_status_hidden_deleted.up.sql#L4-L6)
- [20250915152136_game_rule_json.up.sql](file://backend\migrations\20250915152136_game_rule_json.up.sql#L4-L27)

### 演员账户表 (actors)

该表存储游戏中演员（玩家）的账户信息。

**字段说明：**
- `id`：**演员唯一标识符(UUID)**，主键。
- `game_id`：**所属游戏ID**，外键，关联 `games` 表的 `id` 字段。当游戏被删除时，该演员的所有记录将被级联删除（`ON DELETE CASCADE`）。
- `name`：**演员名称**，非空。
- `password`：**演员密码(6-8位字母数字)**，非空，长度为8位，用于演员登录游戏。
- `team_id`：**队伍ID**，整数类型，非空，默认值为0。0表示未加入任何队伍，其他值表示所属队伍编号。
- `created_at` 和 `updated_at`：创建和更新时间戳。
- **索引**：在 `game_id` 和 `name` 字段上建立了索引，以优化按游戏和名称查询演员的性能。

**Section sources**
- [20250825105153_init_schema.up.sql](file://backend\migrations\20250825105153_init_schema.up.sql#L43-L57)

## 数据库ER图

```
erDiagram
admin_users ||--o{ games : "创建"
rule_templates }o--|| games : "初始化"
games ||--o{ actors : "包含"
games ||--o{ game_logs : "生成"
games ||--o{ kill_records : "生成"
actors ||--o{ kill_records : "作为击杀者"
actors ||--o{ kill_records : "作为被击杀者"
actors ||--o{ game_logs : "关联"
admin_users {
VARCHAR(36) id PK
VARCHAR(50) username UK
VARCHAR(255) password
BOOLEAN is_super_admin
TIMESTAMP created_at
TIMESTAMP updated_at
}
rule_templates {
VARCHAR(36) id PK
VARCHAR(100) template_name
TEXT description
BOOLEAN is_active
JSON rules_config
TIMESTAMP created_at
TIMESTAMP updated_at
}
games {
VARCHAR(36) id PK
VARCHAR(100) name
TEXT description
VARCHAR(50) director_password
INT max_players
ENUM status
JSON rules_config
TIMESTAMP created_at
TIMESTAMP updated_at
}
actors {
VARCHAR(36) id PK
VARCHAR(36) game_id FK
VARCHAR(50) name
VARCHAR(8) password
INT team_id
TIMESTAMP created_at
TIMESTAMP updated_at
}
game_logs {
VARCHAR(36) id PK
VARCHAR(36) game_id FK
ENUM level
TEXT message
VARCHAR(36) player_id FK
TIMESTAMP timestamp
}
kill_records {
VARCHAR(36) id PK
VARCHAR(36) game_id FK
VARCHAR(36) killer_id FK
VARCHAR(36) victim_id FK
TIMESTAMP kill_time
VARCHAR(50) cause
VARCHAR(50) weapon
VARCHAR(100) location
}
```

**Diagram sources**
- [20250825105153_init_schema.up.sql](file://backend\migrations\20250825105153_init_schema.up.sql)
- [20250826121055_add_game_status_hidden_deleted.up.sql](file://backend\migrations\20250826121055_add_game_status_hidden_deleted.up.sql)
- [20250915152136_game_rule_json.up.sql](file://backend\migrations\20250915152136_game_rule_json.up.sql)

## 数据库迁移策略与版本控制

项目采用 `sqlx` 工具进行数据库迁移管理，确保数据库模式的版本控制和可重复部署。

**迁移文件结构：**
- 迁移文件位于 `backend/migrations/` 目录下。
- 每个迁移由一对 `.up.sql` 和 `.down.sql` 文件组成：
  - `.up.sql`：定义如何应用迁移（如创建表、添加列）。
  - `.down.sql`：定义如何回滚迁移（如删除表、删除列）。
- 示例文件：
  - `20250825105153_init_schema.up.sql`：创建所有核心表结构。
  - `20250825105158_seed_test_data.up.sql`：插入初始测试数据。
  - `20250826121055_add_game_status_hidden_deleted.up.sql`：为 `games` 表的 `status` 字段添加 `hidden` 和 `deleted` 枚举值。
  - **新增**：`20250915152136_game_rule_json.up.sql`：执行了重大的数据库结构变更，将规则配置从 `rule_templates` 表直接复制到 `games` 表的 `rules_config` 字段，并移除了 `rule_template_id` 外键。

**工作流程：**
1.  **初始化**：通过 `sqlx migrate run` 命令，按时间戳顺序执行所有 `.up.sql` 脚本，初始化数据库。
2.  **回滚**：通过 `sqlx migrate revert` 命令，执行最新的 `.down.sql` 脚本进行回滚。
3.  **创建新迁移**：使用 `sqlx migrate add -r <name>` 命令生成新的迁移对，然后在 `.up.sql` 中编写变更SQL，在 `.down.sql` 中编写回滚SQL。

此策略保证了数据库变更的可追溯性和安全性。

**Section sources**
- [README.md](file://backend\migrations\README.md)
- [20250825105153_init_schema.up.sql](file://backend\migrations\20250825105153_init_schema.up.sql)
- [20250826121055_add_game_status_hidden_deleted.up.sql](file://backend\migrations\20250826121055_add_game_status_hidden_deleted.up.sql)
- [20250915152136_game_rule_json.up.sql](file://backend\migrations\20250915152136_game_rule_json.up.sql)

## SQLx类型安全查询模式

项目通过 `sqlx` 库在Rust中实现类型安全的数据库查询。其核心机制是在编译时验证SQL查询与Rust数据结构的兼容性。

**实现基础：**
- **依赖配置**：在 `Cargo.toml` 中，`sqlx` 依赖启用了 `mysql`, `chrono`, `uuid` 等特性，并通过 `sqlx-macros` 提供编译时检查。
- **编译时检查**：`sqlx` 使用编译时宏（`sqlx::query!`）来解析SQL查询。它会连接到一个数据库（通常在构建时通过 `DATABASE_URL` 环境变量指定），检查SQL语法、参数类型和返回列的类型与名称，确保与Rust代码中的期望完全匹配。如果SQL有误，编译将失败。

**使用模式：**
项目中的 `admin/models.rs` 定义了与数据库表结构匹配的Rust结构体，例如 `AdminUser` 结构体通过 `#[derive(sqlx::FromRow)]` 宏自动实现从数据库行到Rust结构体的转换。在 `admin/service.rs` 中，服务层使用 `sqlx::query_as!` 宏执行类型安全查询：

```rust
// 从数据库查询所有管理员
let admins = sqlx::query_as::<_, AdminUser>(
    r#"
    SELECT id, username, password, is_super_admin, created_at, updated_at 
    FROM admin_users 
    ORDER BY created_at DESC
    "#
)
.fetch_all(&self.pool)
.await?;
```

在此模式下，`sqlx` 会验证：
1.  `SELECT` 语句中的列名 (`id`, `username`, `password`, `is_super_admin`, `created_at`, `updated_at`) 是否存在于 `admin_users` 表中。
2.  这些列的数据类型是否能与 `AdminUser` 结构体中的字段类型 (`String`, `String`, `String`, `bool`, `DateTime<Utc>`) 安全地转换。
3.  查询参数的数量和类型是否匹配。

这种模式极大地减少了运行时因SQL错误导致的崩溃，是Rust项目中安全操作数据库的推荐方式。

**Section sources**
- [Cargo.toml](file://backend\Cargo.toml)
- [models.rs](file://backend\src\admin\models.rs)
- [service.rs](file://backend\src\admin\service.rs)
- [database.rs](file://backend\src\database.rs)

## 游戏状态与筛选逻辑

**Section sources**
- [game/models.rs](file://backend\src\game\models.rs#L0-L51)
- [game/models.rs](file://backend\src\game\models.rs#L106-L153)
- [game/service.rs](file://backend\src\game\service.rs#L160-L189)
- [frontend/src/types/game.ts](file://frontend\src\types\game.ts#L0-L64)
- [frontend/src/utils/gameFilter.ts](file://frontend\src\utils\gameFilter.ts#L0-L115)

### 游戏状态 (GameStatus)

游戏实例的 `status` 字段是一个枚举类型，用于精确描述游戏的生命周期。在原有 `waiting`, `running`, `paused`, `ended` 状态的基础上，新增了两种状态：

- `hidden`：**已隐藏**。此状态下的游戏对普通用户不可见，但仍存在于数据库中。通常用于临时下架或存档的游戏。
- `deleted`：**已删除**。此状态表示游戏已被逻辑删除。它对普通用户完全不可见，但管理员可能仍能在特定视图中查看或恢复。这是一种软删除机制。

在Rust后端，`GameStatus` 枚举在 `game/models.rs` 中定义，并通过 `#[sqlx(type_name = "status")]` 宏与数据库的 `ENUM` 类型进行映射。前端在 `frontend/src/types/game.ts` 中也定义了对应的 `GameStatus` 枚举，确保了前后端类型的一致性。

### 游戏筛选逻辑 (GameFilterType)

为了支持对游戏列表的灵活筛选，系统定义了 `GameFilterType` 枚举。该枚举在后端 `game/models.rs` 和前端 `frontend/src/types/game.ts` 中均有定义。

- `All`：**全部**。此筛选类型返回所有非 `hidden` 和非 `deleted` 的游戏，是默认的筛选视图。
- `Active`：**活动中**。返回 `waiting`, `running`, `paused` 状态的游戏。
- `Waiting`：**等待中**。仅返回 `waiting` 状态的游戏。
- `Running`：**进行中**。仅返回 `running` 状态的游戏。
- `Ended`：**已结束**。仅返回 `ended` 状态的游戏。
- `Hidden`：**已隐藏**。仅返回 `hidden` 状态的游戏（通常仅管理员可见）。
- `Deleted`：**已删除**。仅返回 `deleted` 状态的游戏（通常仅管理员可见）。

**业务逻辑实现**：
- **后端**：在 `game/service.rs` 的 `get_games` 方法中，根据 `GameListQuery` 中的 `filter` 参数，调用 `GameFilterType::get_status_list()` 方法获取对应的状态列表，并动态构建SQL查询的 `WHERE` 子句。
- **前端**：在 `frontend/src/utils/gameFilter.ts` 的 `filterGamesByStatus` 函数中，根据 `GameFilterType` 的值，使用JavaScript的 `filter` 方法对游戏列表进行客户端筛选。