# 部署与配置

<cite>
**本文档引用的文件**  
- [docker-compose.yml](file://docker-compose.yml)
- [Cargo.toml](file://backend/Cargo.toml)
- [main.rs](file://backend/src/main.rs)
- [package.json](file://frontend/package.json)
- [vite.config.ts](file://frontend/vite.config.ts)
- [requirements.txt](file://python_directors/requirements.txt)
- [main.py](file://python_directors/main.py)
- [server.py](file://python_directors/server.py)
- [data.py](file://python_directors/data.py)
- [action.py](file://python_directors/action.py)
- [constants.py](file://python_directors/constants.py)
- [user.py](file://python_directors/user.py)
- [message.py](file://python_directors/message.py)
- [config.rs](file://backend/src/config.rs)
</cite>

## 更新摘要
**变更内容**  
- 更新了后端服务的环境变量配置说明，基于 `config.rs` 文件中的实际配置项
- 新增了开发环境搭建的详细步骤，包括依赖安装和应用启动命令
- 完善了生产环境部署的最佳实践建议
- 更新了各服务的环境变量配置说明

### 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概览](#架构概览)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 简介
本指南详细说明如何部署和配置 `royale-arena` 项目。该系统由多个服务组成，包括使用 Rust 编写的后端服务、使用 Vue 3 构建的前端界面、MySQL 数据库以及一个使用 Flask 框架实现的 Python 导演系统。部署通过 `docker-compose.yml` 文件协调，支持开发和生产环境的快速启动。

## 项目结构
`royale-arena` 项目采用多模块架构，各组件职责明确，便于独立开发和部署。

``mermaid
graph TB
subgraph "根目录"
docker-compose["docker-compose.yml"]
backend_dir["backend/"]
frontend_dir["frontend/"]
python_dir["python_directors/"]
end
backend_dir --> backend["Rust 后端服务"]
frontend_dir --> frontend["Vue 前端应用"]
python_dir --> director["Python 导演系统"]
docker-compose --> backend
docker-compose --> frontend
docker-compose --> mysql["MySQL 数据库"]
docker-compose --> adminer["Adminer (数据库管理)"]
style backend fill:#4CAF50,stroke:#388E3C
style frontend fill:#2196F3,stroke:#1976D2
style director fill:#FF9800,stroke:#F57C00
style mysql fill:#F44336,stroke:#D32F2F
```

**图示来源**
- [docker-compose.yml](file://docker-compose.yml#L1-L67)

**本节来源**
- [docker-compose.yml](file://docker-compose.yml#L1-L67)

## 核心组件
本项目由四个核心服务构成，通过 Docker 网络 `discuz_net` 进行通信。

- **后端服务 (backend)**: 使用 Rust 的 Axum 框架，提供 RESTful API。
- **前端服务 (frontend)**: 使用 Vue 3 和 Vite，提供用户交互界面。
- **数据库服务 (mysql)**: 使用 MySQL 5.7 存储游戏状态和用户数据。
- **导演系统 (python_directors)**: 使用 Flask 实现游戏逻辑、状态管理和消息广播。

**本节来源**
- [docker-compose.yml](file://docker-compose.yml#L1-L67)
- [Cargo.toml](file://backend/Cargo.toml#L1-L43)
- [package.json](file://frontend/package.json#L1-L27)
- [requirements.txt](file://python_directors/requirements.txt#L1-L9)

## 架构概览
整个应用栈的架构如下图所示。前端和后端服务通过 HTTP 通信，后端服务与数据库交互。导演系统独立运行，直接管理游戏状态，并通过其自身的 API 与前端进行交互。

``mermaid
graph LR
User[用户] --> Frontend[前端 (Vite)]
Frontend --> Backend[后端 (Rust/Axum)]
Backend --> MySQL[(MySQL 数据库)]
Frontend --> Director[导演系统 (Flask)]
Director --> MySQL
Director --> Messages[(内存消息队列)]
subgraph "Docker 网络: discuz_net"
Frontend
Backend
MySQL
Director
end
style User fill:#FFC107,stroke:#FFA000
style Frontend fill:#2196F3,stroke:#1976D2
style Backend fill:#4CAF50,stroke:#388E3C
style MySQL fill:#F44336,stroke:#D32F2F
style Director fill:#FF9800,stroke:#F57C00
style Messages fill:#9C27B0,stroke:#7B1FA2
```

**图示来源**
- [docker-compose.yml](file://docker-compose.yml#L1-L67)
- [server.py](file://python_directors/server.py#L1-L82)
- [main.rs](file://backend/src/main.rs#L1-L4)

## 详细组件分析

### 后端服务分析
后端服务基于 Rust 的 Axum 框架构建，使用 SQLx 与 MySQL 数据库交互。其主要职责是为前端提供数据 API。

#### 依赖关系
``mermaid
classDiagram
class Axum {
+Web 框架
}
class SQLx {
+异步数据库驱动
+MySQL 支持
}
class Tracing {
+日志记录
}
class Jsonwebtoken {
+JWT 认证
}
Axum --> SQLx : "依赖"
Axum --> Tracing : "依赖"
Axum --> Jsonwebtoken : "依赖"
```

**图示来源**
- [Cargo.toml](file://backend/Cargo.toml#L1-L43)

#### 启动流程
``mermaid
flowchart TD
Start([启动]) --> LoadEnv["加载环境变量"]
LoadEnv --> InitDB["初始化数据库连接"]
InitDB --> SetupRoutes["设置路由"]
SetupRoutes --> StartServer["启动 Axum 服务器"]
StartServer --> Running([运行中])
```

**本节来源**
- [Cargo.toml](file://backend/Cargo.toml#L1-L43)
- [main.rs](file://backend/src/main.rs#L1-L4)
- [config.rs](file://backend/src/config.rs#L1-L51)

### 前端服务分析
前端是一个基于 Vue 3 的单页应用（SPA），使用 Vite 作为构建工具。

#### 依赖关系
``mermaid
classDiagram
class Vue {
+核心框架
}
class VueRouter {
+路由管理
}
class Pinia {
+状态管理
}
Vue --> VueRouter : "使用"
Vue --> Pinia : "使用"
```

**图示来源**
- [package.json](file://frontend/package.json#L1-L27)

#### 开发服务器启动
``mermaid
sequenceDiagram
participant Dev as "开发人员"
participant CLI as "npm CLI"
participant Vite as "Vite 服务器"
Dev->>CLI : 执行 npm run dev
CLI->>Vite : 启动 Vite
Vite->>Vite : 读取 vite.config.ts
Vite->>Vite : 解析别名 @ -> ./src
Vite->>Vite : 加载 Vue 插件
Vite-->>Dev : 服务器在 http : //localhost : 5173 启动
```

**图示来源**
- [package.json](file://frontend/package.json#L1-L27)
- [vite.config.ts](file://frontend/vite.config.ts#L1-L22)

### Python 导演系统分析
导演系统是游戏逻辑的核心，它不依赖后端服务，而是独立运行并直接管理游戏状态。

#### 系统架构
``mermaid
graph TD
Client[前端] --> Server[Flask App]
Server --> User[用户认证]
Server --> Data[游戏数据]
Server --> Action[行动逻辑]
Server --> Message[消息系统]
User --> user.py
Data --> data.py
Action --> action.py
Message --> message.py
style Server fill:#FF9800,stroke:#F57C00
```

**图示来源**
- [server.py](file://python_directors/server.py#L1-L82)
- [data.py](file://python_directors/data.py#L1-L94)
- [action.py](file://python_directors/action.py#L1-L199)
- [user.py](file://python_directors/user.py#L1-L35)
- [message.py](file://python_directors/message.py#L1-L39)

#### 用户登录流程
``mermaid
sequenceDiagram
participant Browser as "浏览器"
participant Flask as "Flask 服务器"
participant User as "user.py"
Browser->>Flask : POST /api/login (id=密码)
Flask->>User : encrypt(密码)
User-->>Flask : 返回加密密钥
Flask->>Flask : 重定向到 /api/view/<密钥>
Flask-->>Browser : 302 重定向
```

**图示来源**
- [server.py](file://python_directors/server.py#L1-L82)
- [user.py](file://python_directors/user.py#L1-L35)

#### 游戏行动流程 (以攻击为例)
``mermaid
flowchart TD
A[用户提交攻击表单] --> B{角色和目标是否有效?}
B --> |否| C[返回“攻击失败"]
B --> |是| D[调用 do_attack()]
D --> E[计算伤害]
E --> F[更新目标生命值]
F --> G[发送系统消息]
G --> H[更新体力]
H --> I[返回结果]
```

**图示来源**
- [server.py](file://python_directors/server.py#L1-L82)
- [action.py](file://python_directors/action.py#L1-L199)

## 依赖分析
各服务之间的依赖关系清晰，通过 Docker Compose 进行编排。

``mermaid
graph TD
docker-compose["docker-compose.yml"] --> backend
docker-compose --> frontend
docker-compose --> mysql
docker-compose --> adminer
backend -.-> mysql : "数据库连接"
frontend -.-> backend : "API 调用"
frontend -.-> director : "直接 API 调用"
director -.-> mysql : "可选: 持久化状态"
style docker-compose fill:#607D8B,stroke:#455A64
```

**图示来源**
- [docker-compose.yml](file://docker-compose.yml#L1-L67)

**本节来源**
- [docker-compose.yml](file://docker-compose.yml#L1-L67)

## 性能考虑
- **后端**: Rust 的高性能确保了 API 的低延迟。
- **导演系统**: 使用内存数据结构存储游戏状态，读写速度快，但重启后状态会丢失。在生产环境中，应考虑将 `data.py` 中的状态持久化到数据库。
- **前端**: Vite 的按需编译提供了快速的开发体验。

## 故障排除指南
- **服务无法启动**: 检查 `docker-compose logs` 输出，确认端口是否被占用（8080, 5173, 3306, 8081）。
- **数据库连接失败**: 确认 `MYSQL_ROOT_PASSWORD`, `MYSQL_USER`, `MYSQL_PASSWORD` 环境变量已正确设置。
- **前端无法访问后端**: 确保前端代码中的 API 地址指向 `http://localhost:8080`。
- **导演系统功能异常**: 检查 `python_directors` 目录下的 `requirements.txt` 是否已安装，以及 `server.py` 中的路由是否正确。

**本节来源**
- [docker-compose.yml](file://docker-compose.yml#L1-L67)
- [server.py](file://python_directors/server.py#L1-L82)

## 结论
`royale-arena` 项目通过 Docker Compose 实现了多服务的无缝集成。开发人员可以使用提供的配置快速搭建本地环境。对于生产部署，建议：
1.  将 `Dockerfile.dev` 替换为生产级的 `Dockerfile`。
2.  为所有服务配置 HTTPS。
3.  将导演系统的内存状态持久化到数据库。
4.  使用更强大的数据库备份和监控策略。