# 项目概述

<cite>
**本文档引用的文件**  
- [README.md](file://README.md)
- [backend/Cargo.toml](file://backend/Cargo.toml)
- [backend/src/main.rs](file://backend/src/main.rs)
- [backend/migrations/20250825105153_init_schema.up.sql](file://backend/migrations/20250825105153_init_schema.up.sql)
- [backend/src/admin.rs](file://backend/src/admin.rs)
- [backend/src/admin/service.rs](file://backend/src/admin/service.rs)
- [backend/src/admin/handlers.rs](file://backend/src/admin/handlers.rs)
- [backend/src/admin/models.rs](file://backend/src/admin/models.rs)
- [backend/src/routes.rs](file://backend/src/routes.rs)
- [backend/src/auth/service.rs](file://backend/src/auth/service.rs)
- [backend/src/errors.rs](file://backend/src/errors.rs)
- [frontend/README.md](file://frontend/README.md)
- [python_directors/main.py](file://python_directors/main.py)
- [python_directors/server.py](file://python_directors/server.py)
- [docker-compose.yml](file://docker-compose.yml)
</cite>

## 更新摘要
**变更内容**  
- 更新了系统架构图，准确反映当前组件关系
- 新增了管理员模块的详细分析，包括其API端点、业务逻辑和数据模型
- 更新了后端系统章节，详细说明管理员模块的实现
- 修正了用户角色与工作流部分，准确描述管理员权限层级
- 增强了技术选型分析，补充了管理员模块的设计考量

## 目录
1. [项目概述](#项目概述)
2. [系统架构](#系统架构)
3. [核心组件分析](#核心组件分析)
4. [前端系统](#前端系统)
5. [后端系统](#后端系统)
6. [Python导演系统](#python导演系统)
7. [数据模型](#数据模型)
8. [部署架构](#部署架构)
9. [用户角色与工作流](#用户角色与工作流)
10. [技术选型分析](#技术选型分析)

## 系统架构

``mermaid
graph TB
subgraph "前端"
UI[Vue 3 + TypeScript]
Router[前端路由]
API[API客户端]
end
subgraph "后端"
Web[Axum Web服务器]
DB[(MySQL数据库)]
Auth[JWT认证]
Admin[管理员服务]
end
subgraph "导演系统"
Flask[Flask应用]
Data[游戏状态数据]
Logic[行动逻辑]
end
UI --> Web
Web --> DB
UI --> Flask
Flask --> Data
Flask --> Logic
Logic --> Data
Web --> Admin
Admin --> DB
style UI fill:#f9f,stroke:#333
style Web fill:#bbf,stroke:#333
style Flask fill:#f96,stroke:#333
style DB fill:#9f9,stroke:#333
style Admin fill:#f9c,stroke:#333
```

**图示来源**  
- [README.md](file://README.md)
- [docker-compose.yml](file://docker-compose.yml)

**本节来源**  
- [README.md](file://README.md)

## 核心组件分析

royale-arena 是一个全栈大逃杀游戏系统，采用三组件架构：Vue 3 前端、Rust 后端和 Python 导演系统。这三个组件协同工作，提供完整的在线大逃杀游戏体验。

系统采用微服务架构思想，将不同职责分离到独立的服务中。前端负责用户界面展示，Rust 后端处理核心数据和用户认证，Python 导演系统管理游戏状态和实时互动。

这种架构设计实现了关注点分离，前端专注于用户体验，后端确保数据安全和持久化，导演系统处理复杂的实时游戏逻辑。三个组件通过 HTTP API 进行通信，形成了松耦合的系统结构。后端新增的管理员模块提供了系统管理功能，包括管理员账户的创建、查询、更新和删除操作。

## 前端系统

前端系统基于 Vue 3 + TypeScript + Vite 技术栈构建，提供响应式的网页界面，支持多设备访问。

### 技术栈
- **Vue 3**: 使用 Composition API 构建组件化界面
- **TypeScript**: 提供静态类型检查，增强代码可靠性
- **Vite**: 提供快速的开发服务器和高效的构建工具

### 功能特点
- 实时游戏状态展示
- 响应式设计，适配移动设备
- 用户友好的交互界面
- 与后端和导演系统的无缝集成

``mermaid
flowchart TD
A[用户访问] --> B{身份验证}
B --> |成功| C[加载游戏数据]
B --> |失败| D[显示登录页]
C --> E[渲染游戏界面]
E --> F[监听实时更新]
F --> G[更新UI状态]
```

**图示来源**  
- [frontend/README.md](file://frontend/README.md)

**本节来源**  
- [frontend/README.md](file://frontend/README.md)

## 后端系统

后端系统使用 Rust 语言开发，基于 Axum Web 框架构建，提供 RESTful API 接口和数据持久化服务。

### 技术栈分析
```toml
[dependencies]
axum = "0.8.4"
tokio = { version = "1.0", features = ["full"] }
sqlx = { version = "0.8.6", features = ["runtime-tokio-rustls", "mysql", "chrono", "uuid"] }
serde = { version = "1.0", features = ["derive"] }
jsonwebtoken = "9.3"
```

- **Axum**: 轻量级 Web 框架，提供路由、中间件和错误处理
- **Tokio**: 异步运行时，支持高并发处理
- **Sqlx**: 类型安全的数据库查询库，支持编译时 SQL 检查
- **Serde**: 数据序列化/反序列化框架
- **Jsonwebtoken**: JWT 认证支持

### 核心功能
- 管理员账户管理
- 游戏实例生命周期管理
- 规则模板存储与检索
- 数据持久化与事务处理

``mermaid
sequenceDiagram
participant Frontend as 前端
participant Backend as 后端
participant Database as 数据库
Frontend->>Backend : HTTP请求
Backend->>Database : 查询数据
Database-->>Backend : 返回结果
Backend->>Backend : 处理业务逻辑
Backend-->>Frontend : JSON响应
```

**图示来源**  
- [backend/Cargo.toml](file://backend/Cargo.toml)
- [backend/src/main.rs](file://backend/src/main.rs)

**本节来源**  
- [backend/Cargo.toml](file://backend/Cargo.toml)
- [backend/src/main.rs](file://backend/src/main.rs)

### 管理员模块
管理员模块是后端系统的重要组成部分，提供系统管理功能，包括管理员账户的增删改查操作。

#### API端点
管理员模块提供了以下API端点：
- `POST /api/admin/login`: 管理员登录
- `GET /api/admin/users`: 获取管理员列表（仅超级管理员）
- `POST /api/admin/users`: 创建管理员账户（仅超级管理员）
- `PUT /api/admin/users/:user_id`: 更新管理员账户（仅超级管理员）
- `DELETE /api/admin/users/:user_id`: 删除管理员账户（仅超级管理员）

这些端点通过Axum框架定义，并在`routes.rs`文件中配置路由。

``mermaid
flowchart TD
A[HTTP请求] --> B{路由匹配}
B --> |/api/admin/login| C[admin_login处理程序]
B --> |/api/admin/users| D[权限检查]
D --> |GET| E[list_admins处理程序]
D --> |POST| F[create_admin处理程序]
D --> |PUT| G[update_admin处理程序]
D --> |DELETE| H[delete_admin处理程序]
```

**图示来源**  
- [backend/src/routes.rs](file://backend/src/routes.rs)
- [backend/src/admin/handlers.rs](file://backend/src/admin/handlers.rs)

**本节来源**  
- [backend/src/routes.rs](file://backend/src/routes.rs)
- [backend/src/admin/handlers.rs](file://backend/src/admin/handlers.rs)

#### 业务逻辑
管理员模块的业务逻辑实现在`admin/service.rs`文件中，主要包含以下功能：

- **账户创建**: 创建新管理员账户时，检查用户名是否已存在，使用bcrypt算法加密密码，然后将用户信息存入数据库。
- **账户查询**: 获取所有管理员账户列表，返回不包含密码的用户信息。
- **账户更新**: 更新管理员账户信息，支持更新用户名、密码和权限级别，同时确保用户名唯一性。
- **账户删除**: 删除管理员账户，但防止删除最后一个超级管理员以确保系统安全。

``mermaid
sequenceDiagram
participant Handler as 处理程序
participant Service as 服务
participant Database as 数据库
Handler->>Service : 调用业务方法
Service->>Service : 验证业务规则
Service->>Database : 执行数据库操作
Database-->>Service : 返回结果
Service-->>Handler : 返回处理结果
```

**图示来源**  
- [backend/src/admin/service.rs](file://backend/src/admin/service.rs)

**本节来源**  
- [backend/src/admin/service.rs](file://backend/src/admin/service.rs)

#### 数据模型
管理员模块的数据模型定义在`admin/models.rs`文件中，主要包括以下结构：

- **AdminUser**: 管理员用户实体，包含ID、用户名、加密密码、是否为超级管理员等字段。
- **AdminUserResponse**: 管理员用户响应结构，不包含密码字段，用于API响应。
- **LoginRequest/LoginResponse**: 登录请求和响应结构。
- **CreateAdminRequest/CreateAdminResponse**: 创建管理员请求和响应结构。
- **UpdateAdminRequest/UpdateAdminResponse**: 更新管理员请求和响应结构。
- **DeleteAdminResponse**: 删除管理员响应结构。
- **JwtClaims**: JWT令牌声明结构，包含用户ID、用户名、权限级别等信息。

``mermaid
classDiagram
class AdminUser {
+String id
+String username
+String password
+bool is_super_admin
+DateTime created_at
+DateTime updated_at
}
class AdminUserResponse {
+String id
+String username
+bool is_super_admin
}
class LoginRequest {
+String username
+String password
}
class LoginResponse {
+bool success
+String token
+u64 expires_in
}
class CreateAdminRequest {
+String username
+String password
+bool is_super_admin
}
class UpdateAdminRequest {
+Option<String> username
+Option<String> password
+Option<bool> is_super_admin
}
AdminUserResponse <|-- AdminUser
```

**图示来源**  
- [backend/src/admin/models.rs](file://backend/src/admin/models.rs)

**本节来源**  
- [backend/src/admin/models.rs](file://backend/src/admin/models.rs)

#### 认证与权限控制
系统使用JWT（JSON Web Token）进行认证和权限控制。认证流程如下：

1. 管理员通过`/api/admin/login`端点提交用户名和密码
2. 认证服务验证凭据，成功后生成JWT令牌
3. 后续请求需要在Authorization头中包含Bearer令牌
4. 中间件验证令牌的有效性，并提取用户信息

权限控制通过中间件实现：
- `jwt_auth_middleware`: 验证JWT令牌的有效性
- `super_admin_middleware`: 确保只有超级管理员才能访问特定端点

``mermaid
sequenceDiagram
participant Client as 客户端
participant Middleware as 中间件
participant Service as 服务
Client->>Middleware : 发送带令牌的请求
Middleware->>Middleware : 验证JWT令牌
alt 令牌有效
Middleware->>Middleware : 提取用户信息
Middleware->>Service : 继续处理请求
else 令牌无效
Middleware-->>Client : 返回401错误
end
```

**图示来源**  
- [backend/src/auth/service.rs](file://backend/src/auth/service.rs)
- [backend/src/auth/middleware.rs](file://backend/src/auth/middleware.rs)

**本节来源**  
- [backend/src/auth/service.rs](file://backend/src/auth/service.rs)
- [backend/src/auth/middleware.rs](file://backend/src/auth/middleware.rs)

#### 错误处理
系统定义了分层的错误处理机制，包括认证错误、服务错误和应用错误：

- **AuthError**: 认证相关错误，如无效凭据、令牌过期等
- **ServiceError**: 服务层错误，如数据库错误、用户已存在等
- **AppError**: 应用层错误，作为顶层错误类型

错误处理实现了`IntoResponse` trait，能够自动转换为适当的HTTP响应。

``mermaid
graph TD
A[错误发生] --> B{错误类型}
B --> |AuthError| C[返回401/403状态码]
B --> |ServiceError| D[返回相应状态码]
B --> |AppError| E[返回500状态码]
C --> F[JSON错误响应]
D --> F
E --> F
```

**图示来源**  
- [backend/src/errors.rs](file://backend/src/errors.rs)

**本节来源**  
- [backend/src/errors.rs](file://backend/src/errors.rs)

## Python导演系统

Python 导演系统是游戏的核心逻辑控制器，负责管理游戏状态、处理玩家行动和维护实时互动。

### 系统结构
```python
from flask import Flask
from gevent.pywsgi import WSGIServer

app = Flask(__name__)
http_server = WSGIServer(('', 8000), app)
```

- **Flask**: 轻量级 Web 框架，处理 HTTP 请求
- **gevent**: 协程库，支持高并发连接
- **WSGI**: Web 服务器网关接口

### 核心模块
- **server.py**: 主应用入口，定义路由和请求处理
- **action.py**: 行动逻辑处理，包括移动、搜索、攻击等
- **data.py**: 游戏状态数据管理
- **constants.py**: 游戏规则常量定义
- **user.py**: 用户认证和权限管理

### 主要功能
- 实时游戏状态更新
- 玩家行动验证与执行
- 导演控制接口
- 消息广播系统

``mermaid
classDiagram
class DirectorSystem {
+Flask app
+dict roles
+dict places
+dict items
+dict globals
+list messages
}
class ActionHandler {
+move(role, to)
+search(role)
+pick(role)
+attack(role, target)
+equip(role, item)
+use_item(role, item)
}
class DataManagement {
+dict users
+dict user_ids
+encrypt(key)
+decrypt(key)
+has_user(user)
+is_director(user)
}
DirectorSystem --> ActionHandler : "包含"
DirectorSystem --> DataManagement : "包含"
ActionHandler --> DataManagement : "依赖"
```

**图示来源**  
- [python_directors/main.py](file://python_directors/main.py)
- [python_directors/server.py](file://python_directors/server.py)
- [python_directors/action.py](file://python_directors/action.py)
- [python_directors/data.py](file://python_directors/data.py)
- [python_directors/user.py](file://python_directors/user.py)

**本节来源**  
- [python_directors/main.py](file://python_directors/main.py)
- [python_directors/server.py](file://python_directors/server.py)
- [python_directors/constants.py](file://python_directors/constants.py)

## 数据模型

系统使用 MySQL 数据库存储持久化数据，包含管理员、游戏实例、演员账户等核心实体。

### 数据库模式
```sql
-- 管理员账户表
CREATE TABLE admin_users (
    id VARCHAR(36) PRIMARY KEY COMMENT '管理员唯一标识符(UUID)',
    username VARCHAR(50) NOT NULL UNIQUE COMMENT '管理员用户名',
    password VARCHAR(255) NOT NULL COMMENT '管理员密码(密文存储)',
    is_super_admin BOOLEAN NOT NULL DEFAULT FALSE COMMENT '是否为超级管理员',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    
    INDEX idx_admin_users_username (username)
) COMMENT '管理员账户表';

-- 游戏实例表
CREATE TABLE games (
    id VARCHAR(36) PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    director_password VARCHAR(50) NOT NULL,
    status ENUM('waiting', 'running', 'paused', 'ended') NOT NULL DEFAULT 'waiting'
);

-- 演员账户表
CREATE TABLE actors (
    id VARCHAR(36) PRIMARY KEY,
    game_id VARCHAR(36) NOT NULL,
    name VARCHAR(50) NOT NULL,
    password VARCHAR(8) NOT NULL,
    FOREIGN KEY (game_id) REFERENCES games(id) ON DELETE CASCADE
);
```

### 实体关系
``mermaid
erDiagram
ADMIN_USERS {
varchar id PK
varchar username UK
varchar password
boolean is_super_admin
timestamp created_at
timestamp updated_at
}
GAMES {
varchar id PK
varchar name
varchar director_password
enum status
varchar rule_template_id FK
timestamp created_at
timestamp updated_at
}
ACTORS {
varchar id PK
varchar game_id FK
varchar name
varchar password
int team_id
timestamp created_at
timestamp updated_at
}
GAME_LOGS {
varchar id PK
varchar game_id FK
enum level
text message
varchar player_id FK
timestamp timestamp
}
KILL_RECORDS {
varchar id PK
varchar game_id FK
varchar killer_id FK
varchar victim_id FK
timestamp kill_time
varchar cause
varchar weapon
varchar location
}
ADMIN_USERS ||--o{ GAMES : "创建"
GAMES ||--o{ ACTORS : "包含"
GAMES ||--o{ GAME_LOGS : "生成"
GAMES ||--o{ KILL_RECORDS : "记录"
ACTORS }o--|| KILL_RECORDS : "参与"
```

**图示来源**  
- [backend/migrations/20250825105153_init_schema.up.sql](file://backend/migrations/20250825105153_init_schema.up.sql)

**本节来源**  
- [backend/migrations/20250825105153_init_schema.up.sql](file://backend/migrations/20250825105153_init_schema.up.sql)

## 部署架构

系统使用 Docker Compose 进行容器化部署，包含后端、数据库、前端和管理工具四个服务。

### 服务配置
```yaml
services:
  backend:
    build: ./backend
    ports: "8080:8080"
    volumes: ./backend:/app
    
  mysql:
    image: mysql:5.7
    ports: "3306:3306"
    environment: MYSQL_ROOT_PASSWORD, MYSQL_USER, MYSQL_PASSWORD
    
  frontend:
    build: ./frontend
    ports: "5173:5173"
    
  adminer:
    image: adminer
    ports: "8081:8080"
```

### 网络拓扑
``mermaid
graph TB
subgraph "Docker网络"
Backend[后端服务:8080]
MySQL[MySQL数据库:3306]
Frontend[前端服务:5173]
Adminer[数据库管理:8081]
end
User --> Frontend
Frontend --> Backend
Backend --> MySQL
Adminer --> MySQL
style Backend fill:#bbf,stroke:#333
style MySQL fill:#9f9,stroke:#333
style Frontend fill:#f9f,stroke:#333
style Adminer fill:#ff9,stroke:#333
```

**图示来源**  
- [docker-compose.yml](file://docker-compose.yml)

**本节来源**  
- [docker-compose.yml](file://docker-compose.yml)

## 用户角色与工作流

系统定义了三种主要用户角色：玩家、导演和管理员，每种角色有不同的权限和工作流程。

### 用户角色
| 角色 | 权限 | 访问点 |
|------|------|--------|
| 玩家 | 执行游戏行动 | 前端界面 |
| 导演 | 控制游戏进程 | 导演系统 |
| 管理员 | 管理系统配置 | 后端API |

管理员角色进一步分为普通管理员和超级管理员：
- **超级管理员**: 拥有所有管理权限，可以创建、更新、删除其他管理员账户
- **普通管理员**: 仅能执行基本管理任务，不能管理其他管理员账户

### 工作流程
``mermaid
flowchart LR
A[玩家登录] --> B[选择游戏]
B --> C[执行行动]
C --> D[查看结果]
D --> C
E[导演登录] --> F[创建游戏]
F --> G[监控游戏]
G --> H[控制进程]
H --> G
I[管理员登录] --> J[管理用户]
J --> K[配置系统]
K --> L[监控日志]
L --> K
```

**本节来源**  
- [README.md](file://README.md)
- [python_directors/constants.py](file://python_directors/constants.py)

## 技术选型分析

### 前端选型：Vue 3 + TypeScript + Vite
- **Vue 3**: Composition API 提供更好的逻辑组织
- **TypeScript**: 静态类型检查减少运行时错误
- **Vite**: 快速热重载提升开发效率

### 后端选型：Rust + Axum
- **Rust**: 内存安全，无垃圾回收，高性能
- **Axum**: 轻量级，类型安全，异步友好
- **优势**: 高并发处理能力，内存安全保证

### 导演系统选型：Python + Flask
- **Python**: 开发效率高，生态丰富
- **Flask**: 轻量级，易于扩展
- **适用场景**: 复杂的游戏逻辑处理

### 数据库选型：MySQL
- 成熟的关系型数据库
- 良好的事务支持
- 广泛的工具生态

### 架构权衡
- **性能 vs 开发效率**: Rust 后端保证性能，Python 导演系统提升开发效率
- **一致性 vs 灵活性**: 分离的系统允许独立扩展和维护
- **安全性 vs 便利性**: JWT 认证平衡安全性和用户体验
- **可维护性**: 管理员模块采用清晰的分层架构（处理程序、服务、模型），提高了代码的可维护性和可测试性

**本节来源**  
- [README.md](file://README.md)
- [backend/Cargo.toml](file://backend/Cargo.toml)
- [frontend/README.md](file://frontend/README.md)